webpackJsonp([0xf6b27600d0a2],{805:function(e,t){e.exports={data:{post:{id:"F:/program/BlogSite/content/posts/2018-12-04--DarkNet-CNN-Analyse/index.md absPath of file >>> MarkdownRemark",html:'<p>在了解 全连接层反向传播的机理后，我在 Google 上找了一圈，都没有找到讲得很好的 CNN 反向传播的计算，本想通过研究 Pytorch 源码分析算法原理，发现 Pytorch 底层是调用 C 代码的，也就不了了之了。最近在学习 Darknet 源码时，终于搞懂了这部分的原理。</p>\n<!--more-->\n<h2>1. 前向传播</h2>\n<p>这里要先说明一点，这个地方对应学过数字信号处理的同学来说，还是非常坑的。</p>\n<p>数字信号处理中，实际的卷积操作如下: </p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>f</mi><mo>∗</mo><mi>h</mi><mo>)</mo><mo>[</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo>]</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mi mathvariant="normal">∞</mi></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mi mathvariant="normal">∞</mi></munderover><mi>f</mi><mo>[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>]</mo><mo>⋅</mo><mi>h</mi><mo>[</mo><mi>m</mi><mo>−</mo><mi>i</mi><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mi>j</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">(f*h)[m,n]=\\sum_{i=-\\infty}^\\infty\\sum_{j=-\\infty}^\\infty f[i,j]\\cdot h[m-i,n-j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mopen">[</span><span class="mord mathdefault">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0651740000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.336em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000007em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">[</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span></span>\n<p>而深度学习的卷积操作如下: </p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>f</mi><mo>∗</mo><mi>h</mi><mo>)</mo><mo>[</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo>]</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mi mathvariant="normal">∞</mi></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mi mathvariant="normal">∞</mi></munderover><mi>f</mi><mo>[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>]</mo><mo>⋅</mo><mi>h</mi><mo>[</mo><mi>i</mi><mo>−</mo><mi>m</mi><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mi>n</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">(f*h)[m,n]=\\sum_{i=-\\infty}^\\infty\\sum_{j=-\\infty}^\\infty f[i,j]\\cdot h[i-m,j-n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mopen">[</span><span class="mord mathdefault">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0651740000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.336em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000007em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">]</span></span></span></span></span>\n<p>也就是说，深度学习中的卷积操作实际上是<strong>相关操作</strong> (correlation)</p>\n<p>在数字信号处理中，一维卷积需要把信号序列 (一般是时间序列) 绕原点翻转，二维卷积则需要把信号序列 (一般是图像序列) 绕中心点旋转 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>18</mn><msup><mn>0</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">180^{\\circ}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.674115em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.674115em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∘</span></span></span></span></span></span></span></span></span></span></span></span> </p>\n<blockquote>\n<p>convolution is a filtering operation. correlation compared the similarity of two sets of data. Correlation is a measure of relatedness of two signals.</p>\n</blockquote>\n<p>但其实，在深度学习中，卷积和相关可以理解为是相同的。</p>\n<p>因为我们学习的就是卷积核权重，即卷积核未知，每次反向传播都会自动更新使得误差最小。而传统的图像处理采用已知的卷积核，如果不做翻转处理，结果完全不一样。当然，卷积核绕中心 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>18</mn><msup><mn>0</mn><mo>∘</mo></msup></mrow><annotation encoding="application/x-tex">180^{\\circ}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.674115em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.674115em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∘</span></span></span></span></span></span></span></span></span></span></span></span> 对称的话，两种处理结果也是相同的。</p>\n<p>感兴趣的还可以看下 我的这篇博客 <a href="http://brunoliu.com/2018/06/14/thinking-of-2d-convolution/">Thinking of 2D convolution</a></p>\n<h3>1.1 输出尺寸</h3>\n<p>大多数博客只提到 CNN 算法的前向传播原理。其实如果搞过传统图像处理的，应该都知道，卷积层的本质就是滤波，包括高通滤波用于边缘检测，低通滤波 (如高斯滤波器) 用于图片平滑。感兴趣的可以去找相关书籍看看。</p>\n<p>前向传播一个稍微麻烦的地方是 如果根据 input height, input width, kernel size, padding, stride 计算输出 output height , output width </p>\n<p>公式如下: </p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>output height</mtext><mo>=</mo><mo fence="false">⌊</mo><mfrac><mrow><mtext>input height</mtext><mo>+</mo><mn>2</mn><mo>×</mo><mtext>padding</mtext><mo>−</mo><mtext>kernel size</mtext></mrow><mtext>stride</mtext></mfrac><mo fence="false">⌋</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\\text {output height} = \\Big \\lfloor \\cfrac {\\text {input height} + 2 \\times \\text {padding} - \\text {kernel size}} {\\text {stride}} \\Big \\rfloor + 1 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">output height</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.276em;vertical-align:-0.686em;"></span><span class="mord"><span class="delimsizing size2">⌊</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5899999999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">stride</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">input height</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord text"><span class="mord">padding</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord text"><span class="mord">kernel size</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span><span class="mord"><span class="delimsizing size2">⌋</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span>\n<p><code class="language-text">output width</code> 计算是类似的。</p>\n<p>参考论文: <a href="https://arxiv.org/abs/1603.07285">A guide to convolution arithmetic for deep learning</a></p>\n<p>对应的 GitHub repo: <a href="https://github.com/vdumoulin/conv_arithmetic">conv_arithmetic</a></p>\n<h3>1.2 卷积实现</h3>\n<p>这一小节参考的博客: <a href="https://petewarden.com/2015/04/20/why-gemm-is-at-the-heart-of-deep-learning/">Why GEMM is at the heart of deep learning</a> </p>\n<p>本博客着重讲的是第二点，如果实现二维卷积计算 ? </p>\n<p>传统的数字信号处理中，对于两个长度相当的数据，我们通常用傅里叶变换间接求两个信号的卷积。</p>\n<p>但由于深度学习中，常见的卷积核大小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \\times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \\times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span> 等，采用傅里叶变换得不偿失，我们通常利用卷积定义直接计算。</p>\n<p>由此引入本文的核心: <strong>GEMM</strong> — GEneral Matrix to Matrix Multiplication</p>\n<p>它是 BLAS (Basic Linear Algebra Subprograms) library 的一部分。</p>\n<p>GELL 听上去很高大上，是不是 ?</p>\n<p>其实说白了就是 <strong>矩阵乘法</strong> 的计算实现。</p>\n<p>矩阵乘法在深度学习中最直观的使用莫过于全连接层了，输入神经元和权重矩阵进行矩阵乘法，再和偏置矩阵相加，得到输出神经元的值。</p>\n<p>言归正传，回到 CNN 实现</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 50.390625%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVQoz22RTU/CQBBA+6P9C3pCo4mIATSBaKIhHjDh7MVgYvAgggItpYVd2tLS0g8srd0dh6KVRCYvk91m3u5sR+CcA4C7cEbykJLJUBKnhMBvxHEchuGm5n8IbUJl3ZwY1mhqqLopUx0hpo1rcSj3ez1RFPGI3fKVOj5WJle2V527lblbtT3MFWuB21N53DNmWPSVJCuMMFyzWkVRhO0wxoSapufsxQVAkfMi5l9KAPk4FoMlyp7vjwmdGuZIUVRVwSRJUhAEwi3VcpZ9yaAUs9IXzygnkF+uRD/YdGiOB7NBa/DR6XTfdU37aftH5rB2EsgoM8h/RpmsPl7LN3tK4/DlualOCKU0lafakeWgXE5vy7hgcLYlO2qbNva9h9zbS7Pd6TqOs5ZrhB6Yc3xkIeEFBhnnHE7CqJ/KLB3VSOq/tp4MQ8f1ZniCtQzqml53/frC2+be9e8smwRrGQs5Y93ue68/wJ/9NypIzwHGdrMVYfiJE9r+8g0dCCBSGZDZNwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="kernelview"\n        title=""\n        src="/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png"\n        srcset="/static/kernelview-bd0283cc68eb34bae246e8d28931361b-d8578.png 200w,\n/static/kernelview-bd0283cc68eb34bae246e8d28931361b-a4478.png 400w,\n/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png 768w"\n        sizes="(max-width: 768px) 100vw, 768px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>CNN 层输入数据尺寸为 batch_size <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> depth (channel) <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> input height <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> input width，这是一个4维张量，在 Pytorch 中输入张量的顺序也是 batch <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> depth <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> height <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> width </p>\n<p>如果考虑对 batch 循环处理，那么每次的输入数据尺寸为 depth(channel) <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> input height <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> input width </p>\n<p>卷积核的大小则为  output depth <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> depth <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> kernel size <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> kernel size </p>\n<p>注: 这里和别的博客说法不同，一般都将单个卷积核视为二维的，但其实想一下，考虑沿着深度方向 (每个输入通道) 都存在相应的不同卷积核，最后叠加。那么我们直接将沿着深度方向的所有卷积核视为一个卷积核，进行 3 维的相乘累加操作，不是更方便吗 ? </p>\n<p>下图展示了输入数据尺寸为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">1 \\times 2 \\times 5 \\times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span> (batch:1, depth:2, height: 5, width: 5)，卷积核尺寸为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \\times 2 \\times 3 \\times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> (output depth: 3, input depth: 2, kernel size: 3 )，输出数据尺寸为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">1 \\times 3 \\times 3 \\times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 468px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 125%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/ElEQVQ4y41UyWsTURzOQaSCC3gRERRBkHrViyf/AM+epAcpokIREbFbWu0iQkUsaEvrXiJq06Y1LdbUtKmmi91NKralS+qSNrFJJpNZ38ybN/HNvGQyTYL1HYaZ3/y+3/p9z5LMd1RVxU+K5Z6Pf3k44g0nEobRfCx5wUj3szrf7au17qmzjq4F8KeC0PZgjEPaI1lkayuoKj1x7+5yOGxE3D4z8erz+251OT76/Xlrzgar+sEvsizH43FFkvhEQhIEOpFQFOVfYAJDCDEMQ9M08aZoGlcLIcSxOI4jPkYVFnOdvCBgJwCAETGOwek5Caa/6pbMqsonGI5ls3rjGMZswQNnGUZg2EzmTYa96Gi/4mgP0zSpigx25vfP829ttW6XAqEx7flQqOiNrfxDrwCABl6NRApqKvbfqV7c2CBOZKWOOZ+l4vqppgcykPAn1I3uhQVL1c3jjQ00x2lgRhSbR7wtI16aF8wzD0Qj9z0D9q+zpG2SORinGj95Xk1PSRCmepYlCQhC7jLE9ITNB/C8qodLgYEsi5KUSxXcmLx1wykjVDJgzAoAxNzMAk6SkxnvDBmZcTPhaDwUodBW6ssQBv9EqPRiyIFIWd+MRmlthRp4YGKlsNp1usETCMdJLKQna+r1HbX2n2sdhbKkL1mz2tzfjlldZx8Ns7yggR93TO4o7jxS1rcSonSGplh4tXHQUtx9psEDZWCAbz/1Wi50nawfZAjYNx+sezbU5vKRTaY3lXSPLdW/+Px+fDmlU906PB2oeeLpGVtSk2qa27qCVFPPBM8yWBhINRl5jlEgyNATpWUYi8WgzkRjwjyb4TZ+wcIQBDHVWpaesQwpihJF7TcrAOfsj86J1Y6pNf+vqCZPipJ0LmRL0qzqWAyPDbrHlndfth8oc+0s6bn2ehKJrAikrCslzzWkaPIH3e65wzechXWeg+X9lV2zmv1/7jAiKefA972X7IdK+3eV9JTaZ4xVbQNGupN/PljZ4ql9OVzROjSxuJ739vwLqYZktpd71IcAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="conv sum"\n        title=""\n        src="/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png"\n        srcset="/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-96318.png 200w,\n/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-dc6d3.png 400w,\n/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png 468w"\n        sizes="(max-width: 468px) 100vw, 468px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>每次卷积核的运算： 相乘并累加</p>\n<p>矩阵乘法 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mi>A</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">C = AB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span> 的单次运算: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 的行向量与 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span> 的列向量相乘并累加</p>\n<p>不知道你有没有看出来两者的联系 ？</p>\n<p>是的，基本操作都是相乘并累加。</p>\n<p>所有，有的人就想到了，将卷积层的计算也用矩阵乘法实现: </p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 的每一行大小为 depth <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> kernel size <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> kernel size ，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span> 的每一列也是相同大小，矩阵相乘的基本运算对应的就是单次卷积核相乘累加操作。</p>\n<p>也就是说，我们需要将 CNN 层的输入数据重新排列，根据它可以组成矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 的每一行 — 矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 每一行的数据就是按步长移动卷积核后，其对应位置上的原始输入数据。</p>\n<p>如下图所示，将 4维的输入张量数据转为 2维矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> ，通常称为 im2col, 表示 image-to-column</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABYlAAAWJQFJUiTwAAABw0lEQVQoz32R7W+aUBSH+f//g2ZxWdXWIo3V+lIVRAQBqYJcBygvwzl1vgJeFY2J6K5tto+7eT7cnOQ55/xysOv1Gl1uTKa/LduZTGf9gQm3O1S/XC7X/z7M0tpzSxmaPRc07e+SKTf6Cq+rrYUlb5bTfzpqdD5HiOiD2ye6YIpYFIp3ndKdyqY65RigYsNu3uSSuoA779kdDD7loW82Vi/N5WveSNKTDO+/tscMJrWqGnMP2AeFS+uNuEIn3E5G5fC+iP/oFjZ/5cFafYNfqV0yP/9S9r+RYZwZ57CuVNZFYii/ACk7Anmt+Wj3ygMxrbdzTq+yWMzCQ3g+RZbfI7cJZo8zIV7fP9FhipsWMaFV6XMJU3qWm8SoTaiNpCtnAJ82ePwnKNmOafSNbbBzAo3cJW5m+ITk+uFDVoUCmuNKhCYQv5SczsRdtTRopkwp44CKH3iH4wGtbXm9SnBPw1QNPiKo7QM7zmN1XeakrDGgKY21jSoLSN2gJJ0WtZpjkHDjf2Y2PfAGYygzmo/2r+5R5iwGT6fabE56PhlAarkmfVhbrigvIL2gPp/vj0d0JiSPfJtb5MRVSVgVEfy60JmwfwBsmcWHVL5fVAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="im2col corrected"\n        title=""\n        src="/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png"\n        srcset="/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-d8578.png 200w,\n/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-a4478.png 400w,\n/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png 768w"\n        sizes="(max-width: 768px) 100vw, 768px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>有的人可能会说，在步长 stride 比较小，kernel 比较大的情况下，上图中不同 patch 之间必然会相互覆盖 (overlap)，也就是说生成的 2 维矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 会有大量的重复数据，生成这样的矩阵既浪费内存，又浪费时间，效率会高吗 ? </p>\n<p>但是，请相信，和后面的矩阵乘法的高效比起来，这一步浪费的时间是有价值的。</p>\n<blockquote>\n<p>The benefits from the very regular patterns of memory access outweigh the wasteful storage costs. The paper from Nvidia <a href="https://arxiv.org/pdf/1410.0759.pdf">cuDNN: efficient primitives for Deep Learning</a> describe why they ended up with a modified version of GEMM. There are a lot of advantages to being able to batch up a lot of input images against the same kernels at once.</p>\n</blockquote>\n<p>根据前面的分析：</p>\n<ol>\n<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> 的行数为 patch 的数目，即  <code class="language-text">batch size * output height * output width</code> </li>\n<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span> 的列数为卷积核的数目，即 <code class="language-text">output depth</code> </li>\n</ol>\n<p>于是输出的 2 维矩阵大小为:  <code class="language-text">batch size * output height * output width</code>  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">×</span></span></span></span> <code class="language-text">output depth</code> ，在下一层看来，它又是一个新的 4 维矩阵。</p>\n<p>如下图所示: </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 60.15625%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAACCUlEQVQoz22S22+aYBjG/W93vUO6NLV4tWQX7Xax6yVdFXWXS5atii5OBZzNUgWiKKVomBxETh/HgsI+dHTLtjdPngsefnl4yVtI0xQAwLKsIAgURdE0bVsWfJgkSbofx3FEUZQkCfpyuZAlOY7jQ1TILEld4AZeaOqW5/rbeJv+MUEQKIqiqqqmaaL4A3qcv1BwXDBdMKImzMXpaPZ9ueYFhWO4ked5MI6iCPYkv2aXfdBuF0X3223GFxR99Xl9gVnlCv26zr7BzDIGyh+Et6qqwFiYDOTeS5U43wxeqfiZRp4r/TOt/0LjuhmsmjJmoG2nillo0yy3QbXtoE2lyvO38S5dzYiIPArI43hY9AnoJz5xEhFP9dlVcoC/2LWOX+94ufxaa11nGNpxw8UElxqPPRK5H5Zc4nTvpZB4rs+bGbw25aZeaQG0ZedyKldShePmsPkG/0i/f+TixT0GHXEJJCSO9HljD1vK380BbK7NZizcajnpq9gTL+tE/gNrloLpaLaqnQugmFyjqDGEZe5bSB775Gl0jfhkMRoi2QpkDsOdG9Y7zLvE3Fz+5Sf54u6OPzRbX48cAvEHJdAvBtBxxOk+09hG9reBZ9+o/ZHWe9B407sWO4ZpwHglLngGn4+7PEPcMjhH9XiGXE4Ha2mRX9juHyW/Lwzew8awDBM4XqgbtmmBh/AnHxBnXDuuy+IAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="im2colmult corrected1"\n        title=""\n        src="/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png"\n        srcset="/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-d8578.png 200w,\n/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-a4478.png 400w,\n/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png 768w"\n        sizes="(max-width: 768px) 100vw, 768px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>1.3 利用 numpy 验证</h3>\n<p>我们通过 numpy 验证两种方式计算卷积，哪一种更高效。</p>\n<p>背景: </p>\n<ul>\n<li>\n<p>一张灰度图片，大小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>332</mn><mo>×</mo><mn>300</mn></mrow><annotation encoding="application/x-tex">332 \\times 300</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mord">3</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">0</span><span class="mord">0</span></span></span></span>, batch_size = 1， input depth = 1，因此输入数据是二维矩阵； </p>\n<p>通过 python skimage 库读取图片</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">from</span> skimage <span class="token keyword">import</span> io \nio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">\'dog.jpg\'</span><span class="token punctuation">)</span></code></pre>\n      </div>\n</li>\n</ul>\n<p>  \n  <a\n    class="gatsby-resp-image-link"\n    href="/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 332px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 90.36144578313254%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAME/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABtZExLDTnCIP/xAAaEAACAwEBAAAAAAAAAAAAAAABAwACERIx/9oACAEBAAEFAlrrhCDGL5vgCqW6tux0X7P/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAcEAACAgIDAAAAAAAAAAAAAAABEQAQAhIhMZH/2gAIAQEABj8CeXkShHcZmqGgHFC//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARMSGxQf/aAAgBAQABPyFxXWqQzC8RlAND7GqOrdR3Q8mujEJWeRPFhk//2gAMAwEAAgADAAAAEMPHAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB4QAQACAgEFAAAAAAAAAAAAAAEAESExUYGR0eHw/9oACAEBAAE/EECoAWne1hcW8ha3V7gE7MAr5gDUxcHmXmbiQRnvGqbW40ALRUdI0dL6GKxP/9k=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="dog"\n        title=""\n        src="/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg"\n        srcset="/static/dog-085939e2d2f627a80f7608283c0b7574-fbbac.jpg 200w,\n/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg 332w"\n        sizes="(max-width: 332px) 100vw, 332px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ul>\n<li>\n<p>卷积核大小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \\times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> ，ouput depth = 1，padding = 1，stride = 1</p>\n<p>note: 其实这个卷积核是边缘检测算子</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np\nkernel <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>\n      </div>\n</li>\n<li>\n<p>输出为二维矩阵，不考虑 depth 和 batch size，大小和输入数据相同</p>\n</li>\n</ul>\n<p>首先我们实现 <code class="language-text">zero_pad</code> 函数实现 边缘补 0</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">zero_pad</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> pad_height<span class="token punctuation">,</span> pad_width<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">""" Zero-pad an image.\n    Args:\n        image: numpy array of shape (H, W)\n        pad_width: width of the zero padding (left and right padding)\n        pad_height: height of the zero padding (bottom and top padding)\n    Returns:\n        out: numpy array of shape (H+2*pad_height, W+2*pad_width)\n    """</span>\n    H<span class="token punctuation">,</span> W <span class="token operator">=</span> image<span class="token punctuation">.</span>shape\n    out <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    out <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>H<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>pad_height<span class="token punctuation">,</span> W<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>pad_width<span class="token punctuation">]</span><span class="token punctuation">)</span>\n    out<span class="token punctuation">[</span>pad_height<span class="token punctuation">:</span>pad_height<span class="token operator">+</span>H<span class="token punctuation">,</span> pad_width<span class="token punctuation">:</span>pad_width<span class="token operator">+</span>W<span class="token punctuation">]</span> <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n    <span class="token keyword">return</span> out</code></pre>\n      </div>\n<p><strong>方法一:</strong> 通过 卷积定义计算，我们需要使用两个 for 循环</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">conv_fast</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">""" An efficient implementation of convolution filter.\n    Args:\n        image: numpy array of shape (Hi, Wi)\n        kernel: numpy array of shape (Hk, Wk)\n\n    Returns:\n        out: numpy array of shape (Hi, Wi)\n    """</span>\n    Hi<span class="token punctuation">,</span> Wi <span class="token operator">=</span> image<span class="token punctuation">.</span>shape\n    Hk<span class="token punctuation">,</span> Wk <span class="token operator">=</span> kernel<span class="token punctuation">.</span>shape\n    out <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>Hi<span class="token punctuation">,</span> Wi<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    pad_height <span class="token operator">=</span> <span class="token punctuation">(</span>Hk<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>\n    pad_width <span class="token operator">=</span> <span class="token punctuation">(</span>Wk<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>\n    \n    image_padding <span class="token operator">=</span> zero_pad<span class="token punctuation">(</span>image<span class="token punctuation">,</span> pad_height<span class="token punctuation">,</span> pad_width<span class="token punctuation">)</span>\n    <span class="token comment"># 两个 for 循环，按 步长为 1 逐点计算</span>\n    <span class="token keyword">for</span> hi <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Hi<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> wi <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Wi<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            out<span class="token punctuation">[</span>hi<span class="token punctuation">,</span> wi<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>image_padding<span class="token punctuation">[</span>hi<span class="token punctuation">:</span>hi<span class="token operator">+</span>Hk<span class="token punctuation">,</span> wi<span class="token punctuation">:</span>wi<span class="token operator">+</span>Wk<span class="token punctuation">]</span> <span class="token operator">*</span> kernel<span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> out</code></pre>\n      </div>\n<p><strong>方法二:</strong> GEMM，矩阵相乘计算</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">conv_faster</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""\n    Args:\n        image: numpy array of shape (Hi, Wi)\n        kernel: numpy array of shape (Hk, Wk)\n\n    Returns:\n        out: numpy array of shape (Hi, Wi)\n    """</span>\n    Hi<span class="token punctuation">,</span> Wi <span class="token operator">=</span> image<span class="token punctuation">.</span>shape\n    Hk<span class="token punctuation">,</span> Wk <span class="token operator">=</span> kernel<span class="token punctuation">.</span>shape\n    out <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>Hi<span class="token punctuation">,</span> Wi<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    pad_height <span class="token operator">=</span> <span class="token punctuation">(</span>Hk<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>\n    pad_width <span class="token operator">=</span> <span class="token punctuation">(</span>Wk<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>\n    \n    image_padding <span class="token operator">=</span> zero_pad<span class="token punctuation">(</span>image<span class="token punctuation">,</span> pad_height<span class="token punctuation">,</span> pad_width<span class="token punctuation">)</span>\n    \n    gemm_input <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>Hi<span class="token operator">*</span>Wi<span class="token punctuation">,</span> Hk<span class="token operator">*</span>Wk<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment"># 输入数据重排，得到我们需要的矩阵</span>\n    <span class="token keyword">for</span> hi <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Hi<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> wi <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Wi<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            gemm_input<span class="token punctuation">[</span>hi<span class="token operator">*</span>Wi<span class="token operator">+</span>wi<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_padding<span class="token punctuation">[</span>hi<span class="token punctuation">:</span>hi<span class="token operator">+</span>Hk<span class="token punctuation">,</span> wi<span class="token punctuation">:</span>wi<span class="token operator">+</span>Wk<span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n            \n    <span class="token comment"># 一次矩阵乘法计算，直接得到结果</span>\n    <span class="token comment"># out shape: (Hi*Wi, 1)</span>\n    out <span class="token operator">=</span> np<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>gemm_input<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>\n    <span class="token comment"># 整理矩阵形状, out shape: (Hi, Wi)</span>\n    out <span class="token operator">=</span> out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>Hi<span class="token punctuation">,</span> Wi<span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> out</code></pre>\n      </div>\n<p>最终结果: </p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt\n\nt0 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nout_fast <span class="token operator">=</span> conv_fast<span class="token punctuation">(</span>img<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>\nt1 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nout_faster <span class="token operator">=</span> conv_faster<span class="token punctuation">(</span>img<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>\nt2 <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Compare the running time of the two implementations</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"conv_fast: took %f seconds."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"conv_faster: took %f seconds."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Plot conv_nested output</span>\nplt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>out_fast<span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">\'conv_fast\'</span><span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">\'off\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Plot conv_fast output</span>\nplt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>out_faster<span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">\'conv_faster\'</span><span class="token punctuation">)</span>\nplt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">\'off\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Make sure that the two outputs are the same</span>\n<span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>out_fast <span class="token operator">-</span> out_faster<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Different outputs! Check your implementation."</span><span class="token punctuation">)</span></code></pre>\n      </div>\n<p>结果如下: </p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">conv_fast: took 0.563950 seconds.\nconv_faster: took 0.221714 seconds.</code></pre>\n      </div>\n<p>使用 GEMM 算法快了 50%，是不是很有效 !</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 601px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 45.92346089850249%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABo0lEQVQoz2WRy0pCURiFTw3sRZpHo2iWECJC0ShEhx0RIUG83+8gZYg48Al8hJAigiY9gYNAGvcK4fFc+tZBS0jY7L3X/s761/9rTCaTvXq9floul88rlUowmUxexOPxaDqdjqCfoYfz+fyhwY/7MUwILZhIJC5jsVjUNM2rDRcqFApHxnQ6DSB8NhoNr1qtepz9HcArFotOt9v1AB82hq+tVkvvbq1W2+XcZrOp/ckgYQCz5QZ0SOAC+atUKlkqlMvlhjLk/KICcDaGvxzLljnc3BiNRgHMlqqgB0zcrSmJLBXKZDL3MoTxDWHWO2bi1uoMbm7MZjM/oZIAOmpBZ+bmkcLqdDpeNpsdbg1VgIIq7CkE4xBny9BPKEMelpsZOJoPDy4futz/GeqOvlbL4tDU0Z/heDwOtNvtDwlUs9Q2H9hoSvGtRIB3MsTsGV3pV1uOd5vzSn8S+qMSHjCXL4EyVVKde72eWvEGg4HAiQzR3vv9vq/vchqRdrg3Y7FY7PNwTboklUzim9oxN0l4w7oFPJEhhSOkSkkXpyUOXlwKj/APlHJ3/u12OaIAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="conv output"\n        title=""\n        src="/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png"\n        srcset="/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-ae8c5.png 200w,\n/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-d70b4.png 400w,\n/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png 601w"\n        sizes="(max-width: 601px) 100vw, 601px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>1.4 Darknet 实现</h3>\n<p>在 <code class="language-text">convolutional_layer.c</code> 中，实现了 <code class="language-text">forward_convolutional_layer</code> 函数，里面主要使用了两个函数: </p>\n<ol>\n<li><code class="language-text">im2col_cpu</code> : 实现重排，考虑 padding, stride, kernel size 等参数</li>\n<li><code class="language-text">gemm</code> : 实现矩阵乘法 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mi>α</mi><mo>∗</mo><mi>A</mi><mi>B</mi><mo>+</mo><mi>β</mi><mo>∗</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">C = \\alpha * AB + \\beta * C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span></li>\n</ol>\n<p>注意: <code class="language-text">gemm</code> 支持 A, B 转置，因此具体实现有 4 个对应的函数</p>\n<p>这两个函数分别在 <code class="language-text">im2col.c</code> 和 <code class="language-text">gemm.c</code> 实现</p>\n<h2>2. 反向传播</h2>\n<p>说白了，我们要获得 3 个值，该层的 <code class="language-text">weight_updates</code>  和 <code class="language-text">bias_updates</code> ，以及更新前一层的 <code class="language-text">delta</code> </p>\n<p>如果从 GEMM 的角度考虑，得到 <code class="language-text">weight_updates</code> 和 <code class="language-text">bias_updates</code> 就很容易，因为它就是矩阵相乘的偏导，我们只要把前一层的 <code class="language-text">ouput</code> 重排一下重新得到上面的矩阵 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> ，然后和全连接层类似。</p>\n<p>至于 前一层的 <code class="language-text">delta</code> ，我们在计算矩阵偏导后，还需要多一步，逆重排，在 Darknet 中通过 <code class="language-text">col2im_cpu</code> 实现，注意这一步基本是叠加元素叠加实现的。感觉具体细节比较麻烦，主要是如何寻找索引，详细请看 <code class="language-text">col2im_cpu.c</code> 文件</p>',
htmlAst:{type:"root",children:[{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在了解 全连接层反向传播的机理后，我在 Google 上找了一圈，都没有找到讲得很好的 CNN 反向传播的计算，本想通过研究 Pytorch 源码分析算法原理，发现 Pytorch 底层是调用 C 代码的，也就不了了之了。最近在学习 Darknet 源码时，终于搞懂了这部分的原理。"}]},{type:"text",value:"\n"},{type:"comment",value:"more"},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"1. 前向传播"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这里要先说明一点，这个地方对应学过数字信号处理的同学来说，还是非常坑的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"数字信号处理中，实际的卷积操作如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["katex-display"]},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"("}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"f"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"h"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:")"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"m"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"n"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"munderover",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∑"}]},{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"munderover",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∑"}]},{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"f"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"⋅"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"h"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"m"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"n"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"(f*h)[m,n]=\\sum_{i=-\\infty}^\\infty\\sum_{j=-\\infty}^\\infty f[i,j]\\cdot h[m-i,n-j]"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.10764em;"},children:[{type:"text",value:"f"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"h"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"m"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"n"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:3.0651740000000007em;vertical-align:-1.4137769999999998em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mop","op-limits"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.6513970000000002em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-1.8723309999999997em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mathdefault","mtight"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mrel","mtight"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-3.0500049999999996em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{},children:[{type:"element",tagName:"span",properties:{className:["mop","op-symbol","large-op"]},children:[{type:"text",value:"∑"}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-4.300005em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.336em;"},children:[{type:"element",tagName:"span",properties:{},children:[]}]}]}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mop","op-limits"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.6513970000000007em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-1.872331em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mathdefault","mtight"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mrel","mtight"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-3.050005em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{},children:[{type:"element",tagName:"span",properties:{className:["mop","op-symbol","large-op"]},children:[{type:"text",value:"∑"}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-4.3000050000000005em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.4137769999999998em;"},children:[{type:"element",tagName:"span",properties:{},children:[]}]}]}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.10764em;"},children:[{type:"text",value:"f"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"h"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"m"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.85396em;vertical-align:-0.19444em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"n"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"而深度学习的卷积操作如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["katex-display"]},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"("}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"f"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"h"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:")"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"m"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"n"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"munderover",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∑"}]},{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"munderover",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∑"}]},{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{mathvariant:"normal"},children:[{type:"text",value:"∞"}]}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"f"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"⋅"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"h"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"["}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"i"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"m"}]},{type:"element",tagName:"mo",properties:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"j"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"n"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"]"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"(f*h)[m,n]=\\sum_{i=-\\infty}^\\infty\\sum_{j=-\\infty}^\\infty f[i,j]\\cdot h[i-m,j-n]"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.10764em;"},children:[{type:"text",value:"f"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"h"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"m"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"n"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:3.0651740000000007em;vertical-align:-1.4137769999999998em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mop","op-limits"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.6513970000000002em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-1.8723309999999997em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mathdefault","mtight"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mrel","mtight"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-3.0500049999999996em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{},children:[{type:"element",tagName:"span",properties:{className:["mop","op-symbol","large-op"]},children:[{type:"text",value:"∑"}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-4.300005em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.336em;"},children:[{type:"element",tagName:"span",properties:{},children:[]}]}]}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mop","op-limits"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.6513970000000007em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-1.872331em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mathdefault","mtight"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mrel","mtight"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-3.050005em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{},children:[{type:"element",tagName:"span",properties:{className:["mop","op-symbol","large-op"]},children:[{type:"text",value:"∑"}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-4.3000050000000005em;margin-left:0em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3.05em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∞"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.4137769999999998em;"},children:[{type:"element",tagName:"span",properties:{},children:[]}]}]}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.10764em;"},children:[{type:"text",value:"f"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"h"}]},{type:"element",tagName:"span",properties:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"i"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.85396em;vertical-align:-0.19444em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"m"}]},{type:"element",tagName:"span",properties:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05724em;"},children:[{type:"text",value:"j"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"n"}]},{type:"element",tagName:"span",properties:{className:["mclose"]},children:[{type:"text",value:"]"}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"也就是说，深度学习中的卷积操作实际上是"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"相关操作"}]},{type:"text",value:" (correlation)"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在数字信号处理中，一维卷积需要把信号序列 (一般是时间序列) 绕原点翻转，二维卷积则需要把信号序列 (一般是图像序列) 绕中心点旋转 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"18"}]},{type:"element",tagName:"msup",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"0"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∘"}]}]}]
},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"180^{\\circ}"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.674115em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"8"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["msupsub"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:0.674115em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-3.063em;margin-right:0.05em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∘"}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"convolution is a filtering operation. correlation compared the similarity of two sets of data. Correlation is a measure of relatedness of two signals."}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"但其实，在深度学习中，卷积和相关可以理解为是相同的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"因为我们学习的就是卷积核权重，即卷积核未知，每次反向传播都会自动更新使得误差最小。而传统的图像处理采用已知的卷积核，如果不做翻转处理，结果完全不一样。当然，卷积核绕中心 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"18"}]},{type:"element",tagName:"msup",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"0"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∘"}]}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"180^{\\circ}"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.674115em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"8"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["msupsub"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:0.674115em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-3.063em;margin-right:0.05em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tagName:"span",properties:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"element",tagName:"span",properties:{className:["mord","mtight"]},children:[{type:"text",value:"∘"}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:" 对称的话，两种处理结果也是相同的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"感兴趣的还可以看下 我的这篇博客 "},{type:"element",tagName:"a",properties:{href:"http://brunoliu.com/2018/06/14/thinking-of-2d-convolution/"},children:[{type:"text",value:"Thinking of 2D convolution"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.1 输出尺寸"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"大多数博客只提到 CNN 算法的前向传播原理。其实如果搞过传统图像处理的，应该都知道，卷积层的本质就是滤波，包括高通滤波用于边缘检测，低通滤波 (如高斯滤波器) 用于图片平滑。感兴趣的可以去找相关书籍看看。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"前向传播一个稍微麻烦的地方是 如果根据 input height, input width, kernel size, padding, stride 计算输出 output height , output width "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"公式如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["katex-display"]},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mtext",properties:{},children:[{type:"text",value:"output height"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mo",properties:{fence:"false"},children:[{type:"text",value:"⌊"}]},{type:"element",tagName:"mfrac",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mtext",properties:{},children:[{type:"text",value:"input height"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"+"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"2"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mtext",properties:{},children:[{type:"text",value:"padding"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"−"}]},{type:"element",tagName:"mtext",properties:{},children:[{type:"text",value:"kernel size"}]}]},{type:"element",tagName:"mtext",properties:{},children:[{type:"text",value:"stride"}]}]},{type:"element",tagName:"mo",properties:{fence:"false"},children:[{type:"text",value:"⌋"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"+"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"1"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\text {output height} = \\Big \\lfloor \\cfrac {\\text {input height} + 2 \\times \\text {padding} - \\text {kernel size}} {\\text {stride}} \\Big \\rfloor + 1 "}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.8888799999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","text"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"output height"}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:2.276em;vertical-align:-0.686em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["delimsizing","size2"]},children:[{type:"text",value:"⌊"}]}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["mopen","nulldelimiter"]},children:[]},{type:"element",tagName:"span",properties:{className:["mfrac"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:1.5899999999999999em;"},children:[{type:"element",tagName:"span",properties:{style:"top:-2.314em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["mord","text"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"stride"}]}]}]}]},{type:"element",tagName:"span",properties:{style:"top:-3.23em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tagName:"span",properties:{className:["frac-line"],style:"border-bottom-width:0.04em;"},children:[]}]},{type:"element",tagName:"span",properties:{style:"top:-3.74em;"},children:[{type:"element",tagName:"span",properties:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["mord","text"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"input height"}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","text"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"padding"}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","text"]},children:[{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"kernel size"}]}]}]}]}]},{type:"element",tagName:"span",properties:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tagName:"span",properties:{className:["vlist-r"]},children:[{type:"element",tagName:"span",properties:{className:["vlist"],style:"height:0.686em;"},children:[{type:"element",tagName:"span",properties:{},children:[]}]}]}]}]},{type:"element",tagName:"span",properties:{},children:[]}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"element",tagName:"span",properties:{className:["delimsizing","size2"]},children:[{type:"text",value:"⌋"}]}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"1"}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"output width"}]},{type:"text",value:" 计算是类似的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"参考论文: "},{type:"element",tagName:"a",properties:{href:"https://arxiv.org/abs/1603.07285"},children:[{type:"text",value:"A guide to convolution arithmetic for deep learning"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"对应的 GitHub repo: "},{type:"element",tagName:"a",properties:{href:"https://github.com/vdumoulin/conv_arithmetic"},children:[{type:"text",value:"conv_arithmetic"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.2 卷积实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这一小节参考的博客: "},{type:"element",tagName:"a",properties:{href:"https://petewarden.com/2015/04/20/why-gemm-is-at-the-heart-of-deep-learning/"},children:[{type:"text",value:"Why GEMM is at the heart of deep learning"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"本博客着重讲的是第二点，如果实现二维卷积计算 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"传统的数字信号处理中，对于两个长度相当的数据，我们通常用傅里叶变换间接求两个信号的卷积。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"但由于深度学习中，常见的卷积核大小为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"3 \\times 3"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]}]}]}]},{type:"text",value:", "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"5"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"5"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"5 \\times 5"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"5"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"5"}]}]}]}]},{type:"text",value:" 等，采用傅里叶变换得不偿失，我们通常利用卷积定义直接计算。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"由此引入本文的核心: "},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"GEMM"}]},{type:"text",value:" — GEneral Matrix to Matrix Multiplication"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"它是 BLAS (Basic Linear Algebra Subprograms) library 的一部分。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"GELL 听上去很高大上，是不是 ?"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"其实说白了就是 "},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"矩阵乘法"}]},{type:"text",value:" 的计算实现。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"矩阵乘法在深度学习中最直观的使用莫过于全连接层了，输入神经元和权重矩阵进行矩阵乘法，再和偏置矩阵相加，得到输出神经元的值。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"言归正传，回到 CNN 实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 50.390625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVQoz22RTU/CQBBA+6P9C3pCo4mIATSBaKIhHjDh7MVgYvAgggItpYVd2tLS0g8srd0dh6KVRCYvk91m3u5sR+CcA4C7cEbykJLJUBKnhMBvxHEchuGm5n8IbUJl3ZwY1mhqqLopUx0hpo1rcSj3ez1RFPGI3fKVOj5WJle2V527lblbtT3MFWuB21N53DNmWPSVJCuMMFyzWkVRhO0wxoSapufsxQVAkfMi5l9KAPk4FoMlyp7vjwmdGuZIUVRVwSRJUhAEwi3VcpZ9yaAUs9IXzygnkF+uRD/YdGiOB7NBa/DR6XTfdU37aftH5rB2EsgoM8h/RpmsPl7LN3tK4/DlualOCKU0lafakeWgXE5vy7hgcLYlO2qbNva9h9zbS7Pd6TqOs5ZrhB6Yc3xkIeEFBhnnHE7CqJ/KLB3VSOq/tp4MQ8f1ZniCtQzqml53/frC2+be9e8smwRrGQs5Y93ue68/wJ/9NypIzwHGdrMVYfiJE9r+8g0dCCBSGZDZNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"kernelview",title:"",src:"/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png",srcSet:["/static/kernelview-bd0283cc68eb34bae246e8d28931361b-d8578.png 200w","/static/kernelview-bd0283cc68eb34bae246e8d28931361b-a4478.png 400w","/static/kernelview-bd0283cc68eb34bae246e8d28931361b-2cbed.png 768w"],sizes:["(max-width:","768px)","100vw,","768px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"CNN 层输入数据尺寸为 batch_size "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" depth (channel) "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" input height "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" input width，这是一个4维张量，在 Pytorch 中输入张量的顺序也是 batch "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" depth "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" height "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" width "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果考虑对 batch 循环处理，那么每次的输入数据尺寸为 depth(channel) "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" input height "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" input width "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"卷积核的大小则为  output depth "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" depth "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" kernel size "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",
properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" kernel size "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注: 这里和别的博客说法不同，一般都将单个卷积核视为二维的，但其实想一下，考虑沿着深度方向 (每个输入通道) 都存在相应的不同卷积核，最后叠加。那么我们直接将沿着深度方向的所有卷积核视为一个卷积核，进行 3 维的相乘累加操作，不是更方便吗 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"下图展示了输入数据尺寸为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"1"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"2"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"5"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"5"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"1 \\times 2 \\times 5 \\times 5"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"5"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"5"}]}]}]}]},{type:"text",value:" (batch:1, depth:2, height: 5, width: 5)，卷积核尺寸为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"2"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"3 \\times 2 \\times 3 \\times 3"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]}]}]}]},{type:"text",value:" (output depth: 3, input depth: 2, kernel size: 3 )，输出数据尺寸为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"1"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"1 \\times 3 \\times 3 \\times 3"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]}]}]}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 468px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/ElEQVQ4y41UyWsTURzOQaSCC3gRERRBkHrViyf/AM+epAcpokIREbFbWu0iQkUsaEvrXiJq06Y1LdbUtKmmi91NKralS+qSNrFJJpNZ38ybN/HNvGQyTYL1HYaZ3/y+3/p9z5LMd1RVxU+K5Z6Pf3k44g0nEobRfCx5wUj3szrf7au17qmzjq4F8KeC0PZgjEPaI1lkayuoKj1x7+5yOGxE3D4z8erz+251OT76/Xlrzgar+sEvsizH43FFkvhEQhIEOpFQFOVfYAJDCDEMQ9M08aZoGlcLIcSxOI4jPkYVFnOdvCBgJwCAETGOwek5Caa/6pbMqsonGI5ls3rjGMZswQNnGUZg2EzmTYa96Gi/4mgP0zSpigx25vfP829ttW6XAqEx7flQqOiNrfxDrwCABl6NRApqKvbfqV7c2CBOZKWOOZ+l4vqppgcykPAn1I3uhQVL1c3jjQ00x2lgRhSbR7wtI16aF8wzD0Qj9z0D9q+zpG2SORinGj95Xk1PSRCmepYlCQhC7jLE9ITNB/C8qodLgYEsi5KUSxXcmLx1wykjVDJgzAoAxNzMAk6SkxnvDBmZcTPhaDwUodBW6ssQBv9EqPRiyIFIWd+MRmlthRp4YGKlsNp1usETCMdJLKQna+r1HbX2n2sdhbKkL1mz2tzfjlldZx8Ns7yggR93TO4o7jxS1rcSonSGplh4tXHQUtx9psEDZWCAbz/1Wi50nawfZAjYNx+sezbU5vKRTaY3lXSPLdW/+Px+fDmlU906PB2oeeLpGVtSk2qa27qCVFPPBM8yWBhINRl5jlEgyNATpWUYi8WgzkRjwjyb4TZ+wcIQBDHVWpaesQwpihJF7TcrAOfsj86J1Y6pNf+vqCZPipJ0LmRL0qzqWAyPDbrHlndfth8oc+0s6bn2ehKJrAikrCslzzWkaPIH3e65wzechXWeg+X9lV2zmv1/7jAiKefA972X7IdK+3eV9JTaZ4xVbQNGupN/PljZ4ql9OVzROjSxuJ739vwLqYZktpd71IcAAAAASUVORK5CYII='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"conv sum",title:"",src:"/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png",srcSet:["/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-96318.png 200w","/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-dc6d3.png 400w","/static/conv_sum-d38cce429f3e6a048835a85742b45e4a-3f951.png 468w"],sizes:["(max-width:","468px)","100vw,","468px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每次卷积核的运算： 相乘并累加"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"矩阵乘法 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"C"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"B"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"C = AB"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]}]}]}]},{type:"text",value:" 的单次运算: "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 的行向量与 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"B"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"B"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]}]}]}]},{type:"text",value:" 的列向量相乘并累加"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"不知道你有没有看出来两者的联系 ？"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"是的，基本操作都是相乘并累加。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"所有，有的人就想到了，将卷积层的计算也用矩阵乘法实现: "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 的每一行大小为 depth "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" kernel size "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" kernel size ，"},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"B"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"B"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]}]}]}]},{type:"text",value:" 的每一列也是相同大小，矩阵相乘的基本运算对应的就是单次卷积核相乘累加操作。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"也就是说，我们需要将 CNN 层的输入数据重新排列，根据它可以组成矩阵 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 的每一行 — 矩阵 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 每一行的数据就是按步长移动卷积核后，其对应位置上的原始输入数据。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如下图所示，将 4维的输入张量数据转为 2维矩阵 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" ，通常称为 im2col, 表示 image-to-column"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABYlAAAWJQFJUiTwAAABw0lEQVQoz32R7W+aUBSH+f//g2ZxWdXWIo3V+lIVRAQBqYJcBygvwzl1vgJeFY2J6K5tto+7eT7cnOQ55/xysOv1Gl1uTKa/LduZTGf9gQm3O1S/XC7X/z7M0tpzSxmaPRc07e+SKTf6Cq+rrYUlb5bTfzpqdD5HiOiD2ye6YIpYFIp3ndKdyqY65RigYsNu3uSSuoA779kdDD7loW82Vi/N5WveSNKTDO+/tscMJrWqGnMP2AeFS+uNuEIn3E5G5fC+iP/oFjZ/5cFafYNfqV0yP/9S9r+RYZwZ57CuVNZFYii/ACk7Anmt+Wj3ygMxrbdzTq+yWMzCQ3g+RZbfI7cJZo8zIV7fP9FhipsWMaFV6XMJU3qWm8SoTaiNpCtnAJ82ePwnKNmOafSNbbBzAo3cJW5m+ITk+uFDVoUCmuNKhCYQv5SczsRdtTRopkwp44CKH3iH4wGtbXm9SnBPw1QNPiKo7QM7zmN1XeakrDGgKY21jSoLSN2gJJ0WtZpjkHDjf2Y2PfAGYygzmo/2r+5R5iwGT6fabE56PhlAarkmfVhbrigvIL2gPp/vj0d0JiSPfJtb5MRVSVgVEfy60JmwfwBsmcWHVL5fVAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"im2col corrected",title:"",src:"/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png",srcSet:["/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-d8578.png 200w","/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-a4478.png 400w","/static/im2col_corrected-63eafbfa9662eac92b025bfb1337e5f2-2cbed.png 768w"],sizes:["(max-width:","768px)","100vw,","768px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"有的人可能会说，在步长 stride 比较小，kernel 比较大的情况下，上图中不同 patch 之间必然会相互覆盖 (overlap)，也就是说生成的 2 维矩阵 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 会有大量的重复数据，生成这样的矩阵既浪费内存，又浪费时间，效率会高吗 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"但是，请相信，和后面的矩阵乘法的高效比起来，这一步浪费的时间是有价值的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"The benefits from the very regular patterns of memory access outweigh the wasteful storage costs. The paper from Nvidia "},{type:"element",tagName:"a",properties:{href:"https://arxiv.org/pdf/1410.0759.pdf"},children:[{type:"text",value:"cuDNN: efficient primitives for Deep Learning"}]},{type:"text",value:" describe why they ended up with a modified version of GEMM. There are a lot of advantages to being able to batch up a lot of input images against the same kernels at once."}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"根据前面的分析："}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" 的行数为 patch 的数目，即  "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"batch size * output height * output width"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",
properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"B"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"B"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]}]}]}]},{type:"text",value:" 的列数为卷积核的数目，即 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"output depth"}]},{type:"text",value:" "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"于是输出的 2 维矩阵大小为:  "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"batch size * output height * output width"}]},{type:"text",value:"  "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"\\times"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"×"}]}]}]}]},{type:"text",value:" "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"output depth"}]},{type:"text",value:" ，在下一层看来，它又是一个新的 4 维矩阵。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如下图所示: "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 60.15625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAACCUlEQVQoz22S22+aYBjG/W93vUO6NLV4tWQX7Xax6yVdFXWXS5atii5OBZzNUgWiKKVomBxETh/HgsI+dHTLtjdPngsefnl4yVtI0xQAwLKsIAgURdE0bVsWfJgkSbofx3FEUZQkCfpyuZAlOY7jQ1TILEld4AZeaOqW5/rbeJv+MUEQKIqiqqqmaaL4A3qcv1BwXDBdMKImzMXpaPZ9ueYFhWO4ked5MI6iCPYkv2aXfdBuF0X3223GFxR99Xl9gVnlCv26zr7BzDIGyh+Et6qqwFiYDOTeS5U43wxeqfiZRp4r/TOt/0LjuhmsmjJmoG2nillo0yy3QbXtoE2lyvO38S5dzYiIPArI43hY9AnoJz5xEhFP9dlVcoC/2LWOX+94ufxaa11nGNpxw8UElxqPPRK5H5Zc4nTvpZB4rs+bGbw25aZeaQG0ZedyKldShePmsPkG/0i/f+TixT0GHXEJJCSO9HljD1vK380BbK7NZizcajnpq9gTL+tE/gNrloLpaLaqnQugmFyjqDGEZe5bSB775Gl0jfhkMRoi2QpkDsOdG9Y7zLvE3Fz+5Sf54u6OPzRbX48cAvEHJdAvBtBxxOk+09hG9reBZ9+o/ZHWe9B407sWO4ZpwHglLngGn4+7PEPcMjhH9XiGXE4Ha2mRX9juHyW/Lwzew8awDBM4XqgbtmmBh/AnHxBnXDuuy+IAAAAASUVORK5CYII='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"im2colmult corrected1",title:"",src:"/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png",srcSet:["/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-d8578.png 200w","/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-a4478.png 400w","/static/im2colmult_corrected1-fdef98e61d012beb0d354104f6753c94-2cbed.png 768w"],sizes:["(max-width:","768px)","100vw,","768px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.3 利用 numpy 验证"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"我们通过 numpy 验证两种方式计算卷积，哪一种更高效。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"背景: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"一张灰度图片，大小为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"332"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"300"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"332 \\times 300"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"0"}]}]}]}]},{type:"text",value:", batch_size = 1， input depth = 1，因此输入数据是二维矩阵； "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"通过 python skimage 库读取图片"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"from"}]},{type:"text",value:" skimage "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"import"}]},{type:"text",value:" io \nio"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"imread"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'dog.jpg'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"  \n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 332px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 90.36144578313254%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAME/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABtZExLDTnCIP/xAAaEAACAwEBAAAAAAAAAAAAAAABAwACERIx/9oACAEBAAEFAlrrhCDGL5vgCqW6tux0X7P/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAcEAACAgIDAAAAAAAAAAAAAAABEQAQAhIhMZH/2gAIAQEABj8CeXkShHcZmqGgHFC//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARMSGxQf/aAAgBAQABPyFxXWqQzC8RlAND7GqOrdR3Q8mujEJWeRPFhk//2gAMAwEAAgADAAAAEMPHAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB4QAQACAgEFAAAAAAAAAAAAAAEAESExUYGR0eHw/9oACAEBAAE/EECoAWne1hcW8ha3V7gE7MAr5gDUxcHmXmbiQRnvGqbW40ALRUdI0dL6GKxP/9k='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"dog",title:"",src:"/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg",srcSet:["/static/dog-085939e2d2f627a80f7608283c0b7574-fbbac.jpg 200w","/static/dog-085939e2d2f627a80f7608283c0b7574-fc7ff.jpg 332w"],sizes:["(max-width:","332px)","100vw,","332px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"卷积核大小为 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"×"}]},{type:"element",tagName:"mn",properties:{},children:[{type:"text",value:"3"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"3 \\times 3"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.72777em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"×"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord"]},children:[{type:"text",value:"3"}]}]}]}]},{type:"text",value:" ，ouput depth = 1，padding = 1，stride = 1"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"note: 其实这个卷积核是边缘检测算子"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"import"}]},{type:"text",value:" numpy "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"as"}]},{type:"text",value:" np\nkernel "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"array"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"\n  "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:"\n  "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:"\n  "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"输出为二维矩阵，不考虑 depth 和 batch size，大小和输入数据相同"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"首先我们实现 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"zero_pad"}]},{type:"text",value:" 函数实现 边缘补 0"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"zero_pad"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_height"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_width"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","triple-quoted-string","string"]},children:[{type:"text",value:'""" Zero-pad an image.\n    Args:\n        image: numpy array of shape (H, W)\n        pad_width: width of the zero padding (left and right padding)\n        pad_height: height of the zero padding (bottom and top padding)\n    Returns:\n        out: numpy array of shape (H+2*pad_height, W+2*pad_width)\n    """'}]},{type:"text",value:"\n    H"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" W "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"shape\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","boolean"]},children:[{type:"text",value:"None"}]},{type:"text",value:"\n\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"zeros"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"H"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"pad_height"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" W"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"pad_width"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    out"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"pad_height"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"pad_height"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"H"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_width"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"pad_width"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"W"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" out"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"方法一:"}]},{type:"text",value:" 通过 卷积定义计算，我们需要使用两个 for 循环"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"conv_fast"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","triple-quoted-string","string"]},children:[{type:"text",value:'""" An efficient implementation of convolution filter.\n    Args:\n        image: numpy array of shape (Hi, Wi)\n        kernel: numpy array of shape (Hk, Wk)\n\n    Returns:\n        out: numpy array of shape (Hi, Wi)\n    """'}]},{type:"text",value:"\n    Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wi "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"shape\n    Hk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wk "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"shape\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"zeros"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n    pad_height "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hk"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"//"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n    pad_width "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Wk"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"//"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n    \n    image_padding "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" zero_pad"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_height"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_width"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 两个 for 循环，按 步长为 1 逐点计算"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" hi "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" wi "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{
className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n            out"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"sum"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image_padding"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"Hk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"wi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"Wk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" out"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"方法二:"}]},{type:"text",value:" GEMM，矩阵相乘计算"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"conv_faster"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","triple-quoted-string","string"]},children:[{type:"text",value:'"""\n    Args:\n        image: numpy array of shape (Hi, Wi)\n        kernel: numpy array of shape (Hk, Wk)\n\n    Returns:\n        out: numpy array of shape (Hi, Wi)\n    """'}]},{type:"text",value:"\n    Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wi "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"shape\n    Hk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wk "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"shape\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"zeros"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n    pad_height "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hk"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"//"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n    pad_width "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Wk"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"//"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n    \n    image_padding "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" zero_pad"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"image"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_height"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" pad_width"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    \n    gemm_input "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"zeros"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Hk"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"Wk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 输入数据重排，得到我们需要的矩阵"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" hi "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" wi "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n            gemm_input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"Wi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" image_padding"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"hi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"Hk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"wi"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"text",value:"Wk"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"reshape"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n            \n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 一次矩阵乘法计算，直接得到结果"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# out shape: (Hi*Wi, 1)"}]},{type:"text",value:"\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"matmul"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"gemm_input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 整理矩阵形状, out shape: (Hi, Wi)"}]},{type:"text",value:"\n    out "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" out"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"reshape"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Hi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Wi"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" out"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"最终结果: "}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"import"}]},{type:"text",value:" matplotlib"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"pyplot "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"as"}]},{type:"text",value:" plt\n\nt0 "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" time"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nout_fast "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" conv_fast"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"img"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nt1 "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" time"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nout_faster "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" conv_faster"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"img"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" kernel"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nt2 "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" time"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Compare the running time of the two implementations"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:'"conv_fast: took %f seconds."'}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"%"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"t1 "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"text",value:" t0"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:'"conv_faster: took %f seconds."'}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"%"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"t2 "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"text",value:" t1"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Plot conv_nested output"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"subplot"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"imshow"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"out_fast"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"title"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'conv_fast'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"axis"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'off'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Plot conv_fast output"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"subplot"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"imshow"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"out_faster"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"title"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'conv_faster'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nplt"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"axis"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'off'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Make sure that the two outputs are the same"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"not"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"np"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"max"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"out_fast "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"text",value:" out_faster"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1e"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"10"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:'"Different outputs! Check your implementation."'}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"结果如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"text"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-text"]},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"conv_fast: took 0.563950 seconds.\nconv_faster: took 0.221714 seconds."}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"使用 GEMM 算法快了 50%，是不是很有效 !"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 601px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 45.92346089850249%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABo0lEQVQoz2WRy0pCURiFTw3sRZpHo2iWECJC0ShEhx0RIUG83+8gZYg48Al8hJAigiY9gYNAGvcK4fFc+tZBS0jY7L3X/s761/9rTCaTvXq9floul88rlUowmUxexOPxaDqdjqCfoYfz+fyhwY/7MUwILZhIJC5jsVjUNM2rDRcqFApHxnQ6DSB8NhoNr1qtepz9HcArFotOt9v1AB82hq+tVkvvbq1W2+XcZrOp/ckgYQCz5QZ0SOAC+atUKlkqlMvlhjLk/KICcDaGvxzLljnc3BiNRgHMlqqgB0zcrSmJLBXKZDL3MoTxDWHWO2bi1uoMbm7MZjM/oZIAOmpBZ+bmkcLqdDpeNpsdbg1VgIIq7CkE4xBny9BPKEMelpsZOJoPDy4futz/GeqOvlbL4tDU0Z/heDwOtNvtDwlUs9Q2H9hoSvGtRIB3MsTsGV3pV1uOd5vzSn8S+qMSHjCXL4EyVVKde72eWvEGg4HAiQzR3vv9vq/vchqRdrg3Y7FY7PNwTboklUzim9oxN0l4w7oFPJEhhSOkSkkXpyUOXlwKj/APlHJ3/u12OaIAAAAASUVORK5CYII='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"conv output",title:"",src:"/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png",srcSet:["/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-ae8c5.png 200w","/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-d70b4.png 400w","/static/conv_output-0e41c7abfd372c6cf1591b57da07dbcc-3afee.png 601w"],sizes:["(max-width:","601px)","100vw,","601px"]},children:[]},{type:"text",value:"\n    "
}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.4 Darknet 实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"convolutional_layer.c"}]},{type:"text",value:" 中，实现了 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"forward_convolutional_layer"}]},{type:"text",value:" 函数，里面主要使用了两个函数: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"im2col_cpu"}]},{type:"text",value:" : 实现重排，考虑 padding, stride, kernel size 等参数"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"gemm"}]},{type:"text",value:" : 实现矩阵乘法 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"C"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"="}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"α"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"B"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"+"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"β"}]},{type:"element",tagName:"mo",properties:{},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"C"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"C = \\alpha * AB + \\beta * C"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.46528em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.0037em;"},children:[{type:"text",value:"α"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.76666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.8888799999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.05278em;"},children:[{type:"text",value:"β"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mbin"]},children:[{type:"text",value:"∗"}]},{type:"element",tagName:"span",properties:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]}]}]}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注意: "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"gemm"}]},{type:"text",value:" 支持 A, B 转置，因此具体实现有 4 个对应的函数"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这两个函数分别在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"im2col.c"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"gemm.c"}]},{type:"text",value:" 实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"2. 反向传播"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"说白了，我们要获得 3 个值，该层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"weight_updates"}]},{type:"text",value:"  和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"bias_updates"}]},{type:"text",value:" ，以及更新前一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果从 GEMM 的角度考虑，得到 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"weight_updates"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"bias_updates"}]},{type:"text",value:" 就很容易，因为它就是矩阵相乘的偏导，我们只要把前一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"ouput"}]},{type:"text",value:" 重排一下重新得到上面的矩阵 "},{type:"element",tagName:"span",properties:{className:["katex"]},children:[{type:"element",tagName:"span",properties:{className:["katex-mathml"]},children:[{type:"element",tagName:"math",properties:{},children:[{type:"element",tagName:"semantics",properties:{},children:[{type:"element",tagName:"mrow",properties:{},children:[{type:"element",tagName:"mi",properties:{},children:[{type:"text",value:"A"}]}]},{type:"element",tagName:"annotation",properties:{encoding:"application/x-tex"},children:[{type:"text",value:"A"}]}]}]}]},{type:"element",tagName:"span",properties:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tagName:"span",properties:{className:["base"]},children:[{type:"element",tagName:"span",properties:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tagName:"span",properties:{className:["mord","mathdefault"]},children:[{type:"text",value:"A"}]}]}]}]},{type:"text",value:" ，然后和全连接层类似。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"至于 前一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" ，我们在计算矩阵偏导后，还需要多一步，逆重排，在 Darknet 中通过 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"col2im_cpu"}]},{type:"text",value:" 实现，注意这一步基本是叠加元素叠加实现的。感觉具体细节比较麻烦，主要是如何寻找索引，详细请看 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"col2im_cpu.c"}]},{type:"text",value:" 文件"}]}],data:{quirksMode:!1}},fields:{slug:"/DarkNet-CNN-Analyse/",prefix:"2018-12-04"},frontmatter:{title:"DarkNet CNN Analyse",subTitle:"介绍 DarkNet CNN 实现原理",cover:{childImageSharp:{resize:{src:"/static/darknet-a128141842710e6137de63943fa20758-160fa.png"}}}}},author:{id:"F:/program/BlogSite/content/parts/author.md absPath of file >>> MarkdownRemark",html:"<p>我是一名数据工程师，对硬件有浓厚的兴趣。</p>"},footnote:{id:"F:/program/BlogSite/content/parts/footnote.md absPath of file >>> MarkdownRemark",html:'<ul>\n<li>this is a site built by <a href="https://www.gatsbyjs.org/">GatsbyJS</a>, ReactJs, CSS in JS</li>\n<li>delivered by <a href="https://pages.github.com/">Github Page</a></li>\n</ul>'},site:{siteMetadata:{facebook:{appId:""}}}},pathContext:{slug:"/DarkNet-CNN-Analyse/"}}}});
//# sourceMappingURL=path---dark-net-cnn-analyse-2fb8b3c0e26022efa4bc.js.map