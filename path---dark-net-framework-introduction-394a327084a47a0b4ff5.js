webpackJsonp([34391860677011],{817:function(e,t){e.exports={data:{post:{id:"F:/program/BlogSite/content/posts/2018-12-04--DarkNet-Framework-Introduction/index.md absPath of file >>> MarkdownRemark",html:'<p>最近在看 YoLo 源码的时候，发现原作者使用的是一个叫 DarkNet 的神经网络库，地址如下: <a href="https://github.com/pjreddie/darknet">https://github.com/pjreddie/darknet</a></p>\n<blockquote>\n<p>Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation </p>\n</blockquote>\n<p>我在 Github 搜索时，发现 star 第二多的是一个中国人，仓库地址: <a href="https://github.com/hgpvision/darknet">hgpvision/darknet</a> ，他对 DarkNet 的源码做了非常详细的注释。</p>\n<p>由于我之前在学习 deeplearning. ai 的课程时，曾经跟着课后作业写过一个居于 Numpy 的 Python 神经网络库，同时也总结了一下流程。</p>\n<p>于是就想对 DarkNet 的源码也做一番分析，这里写下自己的心得体会</p>\n<p>如果对神经网络算法实现感兴趣的，本文会有一些帮助。但这此之前，必须搞懂神经网络的理论原理，否则会有一些困难。</p>\n<!--more-->\n<h2>1. 模型导入</h2>\n<h3>1.1 模型定义文本</h3>\n<p>不同框架模型导入机制不同。DarkNet 和 Caffe 都是基于 C/C++ 的，因此 DarkNet 也借鉴了 Caffe 的模型定义 </p>\n<p>DarkNet 的 模型定义文件 后缀为 <code class="language-text">.cfg</code> ，<code class="language-text">txt</code> 文本类型</p>\n<ul>\n<li>\n<p>每一层网络都采用 <code class="language-text">[name]</code> 标记该层类型，比如 <code class="language-text">[convolutional]</code> 表示卷积层， <code class="language-text">[maxpool]</code> 表示 池化层 , <code class="language-text">[connected]</code> 表示全连接层</p>\n</li>\n<li>\n<p>每一层网络的参数 (hyperparameter) 采用 <code class="language-text">key = value</code> 格式定义，</p>\n<p>比如下面是 AlexNet  的第一层卷积层: </p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">[convolutional]\nfilters=96\t\t# 卷积核个数\nsize=11\t\t\t# 卷积核尺寸 (长宽相同)\nstride=4\t\t# 移动步长\npad=0\t\t\t# 是否在边缘补 0\nactivation=relu\t # Relu 激活函数</code></pre>\n      </div>\n</li>\n<li>\n<p>模型文本的第一层网络定义的是全局通用参数，该层类型为 <code class="language-text">[net]</code> </p>\n<p>常见参数如下: </p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">batch\t\t\t# 每次处理的批个数\nheight / width   # 输入图片高度/宽度\nchannel\t\t\t# 输入图片通道，一般为 3 (RGB)\ndecay\t\t\t# 正则项系数，也称衰减系数\nmomentum\t\t# 动量，x &lt;- momentum * x - alpha * dx \nlearning_rate\t # 学习率</code></pre>\n      </div>\n</li>\n</ul>\n<h3>1.2 利用 链表 表征读取的模型文本</h3>\n<p>DarkNet 采用 双向链表 将 <code class="language-text">.cfg</code> 文本定义的模型读取到内存中</p>\n<p><code class="language-text">list</code> 和 <code class="language-text">node</code> 结构体定义在 <code class="language-text">list.h</code> 和 <code class="language-text">list.c</code> 文件，<code class="language-text">node</code> 存储的数据的类型为 <code class="language-text">void *</code> 类型</p>\n<p>在具体应用中，每个节点 (node) 存储的数据类型为 <code class="language-text">section</code> 结构体，定义在 <code class="language-text">parser.c</code> 文件</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token comment">// 双向链表, list.h 文件</span>\n<span class="token keyword">typedef</span> <span class="token keyword">struct</span> list<span class="token punctuation">{</span>\n    <span class="token keyword">int</span> size<span class="token punctuation">;</span>\n    node <span class="token operator">*</span>front<span class="token punctuation">;</span>\n    node <span class="token operator">*</span>back<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> list<span class="token punctuation">;</span>\n\n<span class="token comment">// 链表节点, list.h 文件</span>\n<span class="token keyword">typedef</span> <span class="token keyword">struct</span> node<span class="token punctuation">{</span>\n    <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>\n    <span class="token keyword">struct</span> node <span class="token operator">*</span>next<span class="token punctuation">;</span>\n    <span class="token keyword">struct</span> node <span class="token operator">*</span>prev<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> node<span class="token punctuation">;</span>\n\n<span class="token comment">// 层节点数据，对应 node.val, parse.c 文件</span>\n<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>\n    <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>\t\t \t<span class="token comment">// 每一层类型</span>\n    list <span class="token operator">*</span>options<span class="token punctuation">;</span>\t\t<span class="token comment">// 参数链表</span>\n<span class="token punctuation">}</span>section<span class="token punctuation">;</span>\n\n<span class="token comment">// key - value 结构体, option_list.h 文件</span>\n<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>\n    <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>\n    <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> used<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> kvp<span class="token punctuation">;</span></code></pre>\n      </div>\n<p>读取文本到链表的函数</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token comment">// 读取文本到链表, parser.c 文件</span>\nlist <span class="token operator">*</span><span class="token function">read_cfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span>\n\n<span class="token comment">// 读取每个节点的参数链表, 就是 section 的 options 链表</span>\n<span class="token comment">// option_list.c 文件</span>\n<span class="token keyword">int</span> <span class="token function">read_option</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> list <span class="token operator">*</span>options<span class="token punctuation">)</span></code></pre>\n      </div>\n<p>函数实现的具体功能如下图所示，可供参考</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-37d8e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 70.19464720194647%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAABJ0AAASdAHeZh94AAACMklEQVQoz5VSW08TQRTeH+W/8E/4qokx8mIMPmnipcGI2qImRAUVqYhFRcpFoahQepVWtnTZdrstLKV0Z2dnd/ZSujPrbEkgAUn05GTmnDPny3cuw1EXm2JGXoubYprs/Pbakv/PwlHi2RBYuoba+7C1hwDAtouxA3RL2TeaqtGG2MQOU2y5yLSZ6qZtYMenPqdCXN0B2O12CXN9drVUA5kORJbOTuxCww5swwYQdz3S9SjLg3pgc+f7wucu3A5PJCzHy/DytfDk5YHxXEk2TAcYNrI7qo4t7L6dTV8KjT2MLlLvYCHF9z14d30oxo3OrD2KLuaFhkd8gHB2U14pVEzbPeyq0yUeYQX5oqLGloupYjARuQm+ZjaXcgIXXchGJhKlWpNFGcnol+SLz6tCvTU8tRyOzhcrCotEJr8L0rbvwrH57L2R2Y2qwpIJodz913M3hmI/CxXmN/a0gTfzg9FvP36JkfeJ0Ku51ULlzsv4lcEPmdx6t1F4Np2+OxJfzpd94nke5bCJdrflo+lTGhQJkHXr+Uz/04+ZknxzePpiaDyZWfdbZdLLOF6V7TiaBkmvMRb3mEWp0zmYW1n/lEgrbT22lBuZSdaqklPLK/sgYOxJAD7rAxwSsJ33P4ldfTyVTOX91maPmRwzH5V6AmdiLEm1siBsbW0pu00bQYo1eqLsv3EGzwghqSeiKJZ4XlXV0zRngjHG9Xqd0ZbL5Q2eBwD8HxhCqGma2hPLsk6D/wC7AfcYkfKuggAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="framework"\n        title=""\n        src="/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-48538.png"\n        srcset="/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-bed0f.png 200w,\n/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-5fd34.png 400w,\n/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-48538.png 800w,\n/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-b70ec.png 1200w,\n/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-d134a.png 1600w,\n/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-37d8e.png 1644w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>2. 模型建立</h2>\n<h3>2.1 <code class="language-text">network</code> 和 <code class="language-text">layer</code> 结构体</h3>\n<p><code class="language-text">network</code> 结构体表示整个网络结构，包括所有全局参数和运行时指针传递的功能，这里只介绍几个重要的变量，具体课参考上面提到的博客</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token comment">//定义在 network.h 文件</span>\n<span class="token keyword">typedef</span> <span class="token keyword">struct</span> network<span class="token punctuation">{</span>\n\t<span class="token keyword">int</span> n<span class="token punctuation">;</span>\t\t\t\t<span class="token comment">// 网络层数</span>\n\t<span class="token keyword">int</span> batch<span class="token punctuation">;</span>\t\t\t<span class="token comment">// 参数: 批个数</span>\n\t<span class="token keyword">float</span> epoch<span class="token punctuation">;</span>\t\t<span class="token comment">// 参数: 训练循环次数</span>\n\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> \n\tlayer <span class="token operator">*</span>layers<span class="token punctuation">;</span>\t\t<span class="token comment">// 每一层网络结构体，指针指向数组首地址</span>\n    \n    <span class="token keyword">float</span> <span class="token operator">*</span>input<span class="token punctuation">;</span> \t\t<span class="token comment">// 两个作用，指向网络的初始数据输入首地址，以及网络的前向、后向传播过程中前后层数据指针传递</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span>truth<span class="token punctuation">;</span>\t\t<span class="token comment">// 标签数据 (真实数据)</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span>delta<span class="token punctuation">;</span>\t\t<span class="token comment">// 后向传播的累计梯度相乘</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span>workspace<span class="token punctuation">;</span>\t<span class="token comment">// 后向传播的临时工作空间，用于存储重排的数据，其长度为 所有层中最大的值  l.workspace_size = l.out_h*l.out_w*l.size*l.size*l.c </span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    <span class="token keyword">int</span> h<span class="token punctuation">,</span>w<span class="token punctuation">,</span>c<span class="token punctuation">;</span>\t\t\t<span class="token comment">// 输入的原始数据的 height, width 和 channel </span>\n<span class="token punctuation">}</span> network<span class="token punctuation">;</span></code></pre>\n      </div>\n<p><code class="language-text">layer</code> 结构体表示每一层网络结构，定义在 <code class="language-text">layer.h</code> 文件</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> layer <span class="token punctuation">{</span>\n    LAYER_TYPE type<span class="token punctuation">;</span>\t\t<span class="token comment">// 网络层类型，枚举类型见同一文件</span>\n    ACTIVATION activation<span class="token punctuation">;</span>\t<span class="token comment">// 激活函数类型</span>\n    COST_TYPE cost_type<span class="token punctuation">;</span>\t<span class="token comment">// 损失函数类型，只有输出层定义</span>\n    \n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> \n        \n    <span class="token comment">// 前向传播函数指针，具体实现由每一种网络层类型自己实现</span>\n    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>forward<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> layer<span class="token punctuation">,</span> <span class="token keyword">struct</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>\t\n    <span class="token comment">// 后向传播函数指针</span>\n    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>backward<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> layer<span class="token punctuation">,</span> <span class="token keyword">struct</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 参数更新函数指针</span>\n    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>update<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> layer<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    \n    <span class="token keyword">int</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> c<span class="token punctuation">;</span> \t<span class="token comment">//该层输入数据的 height, width, channel</span>\n    <span class="token keyword">int</span> out_h<span class="token punctuation">,</span> out_w<span class="token punctuation">,</span> out_c<span class="token punctuation">;</span> \t<span class="token comment">//该层输出数据的结构</span>\n    <span class="token keyword">int</span> size<span class="token punctuation">;</span>\t\t<span class="token comment">//卷积核尺寸</span>\n    <span class="token keyword">int</span> stride<span class="token punctuation">;</span>\t\t<span class="token comment">//步长</span>\n    <span class="token keyword">int</span> pad<span class="token punctuation">;</span>\t\t<span class="token comment">//补0长度</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        \n    <span class="token keyword">float</span> <span class="token operator">*</span> output<span class="token punctuation">;</span>\t <span class="token comment">//前向传播的输出数据，每层网络必须开辟内存保存自己的输出数据，当然了，也是下一层的输入数据</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span> delta<span class="token punctuation">;</span>\t <span class="token comment">//反向传播的梯度累计数据，这个也必须每层网络自己保存</span>\n    \n    <span class="token keyword">float</span> <span class="token operator">*</span> weights<span class="token punctuation">;</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span> weight_updates<span class="token punctuation">;</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span> biases<span class="token punctuation">;</span>\n    <span class="token keyword">float</span> <span class="token operator">*</span> bias_updates<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> layer<span class="token punctuation">;</span></code></pre>\n      </div>\n<p>两个结构体的具体变量含义，在后面训练模型的时候就看出来了，这里大致可以理解就 OK 了。这也符合软件开发的流程，我们在大致搭好框架后，每次迭代开发，需要添加新功能时，会在类里面添加新的变量，所有并不是所有的变量是开始就存在的。</p>\n<p>所以放心往下继续看吧。</p>\n<h3>2. 建立模型</h3>\n<p>DarkNet 通过上面的已经获得的双向链表 生成对应的 network 和 layer 结构体，并填充参数。具体函数均在 <code class="language-text">parser.c</code> 文件实现</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token comment">// 导入网络模型，输入为 ".cfg" 文本名称</span>\nnetwork <span class="token function">parse_network_cfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span>\n<span class="token comment">// 导入通用参数，list * options 对应单个网络层的参数链表结构体</span>\n<span class="token keyword">void</span> <span class="token function">parse_net_options</span><span class="token punctuation">(</span>list <span class="token operator">*</span>options<span class="token punctuation">,</span> network <span class="token operator">*</span>net<span class="token punctuation">)</span>\n\n<span class="token comment">// 每一种类别的单层网络有一个对应的解析函数 </span>\n<span class="token comment">// 比如: parse_convolutional, parse_rnn, parse_activation, parse_cost</span>\nlayer <span class="token function">parse_xxx</span><span class="token punctuation">(</span>list <span class="token operator">*</span>options<span class="token punctuation">,</span> size_params params<span class="token punctuation">)</span></code></pre>\n      </div>\n<p><strong>注意</strong>:  <code class="language-text">size_params</code> 结构体定义在 <code class="language-text">parser.c</code> 中，这里必须得提一下，用过 Pytorch 的应该都知道，Pytorch 会根据我们指定的神经网络结构自动计算权重参数的个数，背后的原理就是根据输入数据尺寸和输出数据尺寸以及网络层类型自动计算需要的权重参数。</p>\n<p>DarkNet 怎么干的呢 ? </p>\n<p>以 <code class="language-text">parse_connected</code> 创建全连接层为例，它主要调用了 <code class="language-text">make_connected_layer</code> 函数创建 一个新的 <code class="language-text">layer</code> 结构体 <code class="language-text">l</code>，其中 <code class="language-text">l.weights = calloc(outputs*inputs, sizeof(float))</code> 分配的权重参数个数需要 <code class="language-text">inputs</code> 和 <code class="language-text">outputs</code> 变量，而 <code class="language-text">inputs</code> 变量则是由 <code class="language-text">pramas</code> 传递进来的，后面会详细说明</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python">typedef struct size_params<span class="token punctuation">{</span>\n    <span class="token builtin">int</span> batch<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> inputs<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> h<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> w<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> c<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> index<span class="token punctuation">;</span>\n    <span class="token builtin">int</span> time_steps<span class="token punctuation">;</span>\n    network net<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> size_params<span class="token punctuation">;</span></code></pre>\n      </div>\n<p>函数 <code class="language-text">parse_network_cfg</code> 的流程实现</p>\n<ol>\n<li>\n<p><code class="language-text">list *sections = read_cfg(filename)</code> 获得 链表结构体</p>\n</li>\n<li>\n<p><code class="language-text">node * n = sections -&gt; front</code> 获得链表头节点，同时获得 node 的 value 变量，它是一个 <code class="language-text">section</code> 结构体，在进一步获得 <code class="language-text">section</code> 结构体的 <code class="language-text">options</code> 变量，这就是我们想要的 </p>\n<p><code class="language-text">parse_net_options(options, &amp;net)</code> 解析 <code class="language-text">[net]</code> 层的参数链表结构体 ，并赋值给 <code class="language-text">network</code> 结构体变量</p>\n</li>\n<li>\n<p>新建一个 <code class="language-text">size_params params</code> 变量，将 <code class="language-text">network</code> 结构体的一些参数赋值进来</p>\n</li>\n<li>\n<p>while 循环，终止条件为 节点 n 不存在，即到达尾节点</p>\n<ul>\n<li><code class="language-text">s = (section *)n-&gt;val; options = s-&gt;options;</code> 获得单层参数链表结构体</li>\n<li><code class="language-text">string_to_layer_type(s-&gt;type)</code> 获得 网络层的类别</li>\n<li>根据获得的类别，使用对应的 <code class="language-text">parse_xxx</code> 函数返回对应的 <code class="language-text">layer</code> 结构体，比如 <code class="language-text">l = parse_convolutional(options, params)</code> 实现卷积层解析，其中的 <code class="language-text">params</code> 变量就是上面的建立的结构体</li>\n<li>设置一些特殊的参数变量，比如 <code class="language-text">l.truth</code>, <code class="language-text">l.onlyforward</code>, <code class="language-text">l.stopbackward</code> </li>\n<li><code class="language-text">net.layers[count] = l</code> 将 <code class="language-text">layer</code> 结构体传递到 <code class="language-text">network</code> 结构体</li>\n<li>根据 <code class="language-text">l.workspace_size</code> 设置 workspace 临时变量</li>\n<li><code class="language-text">n = n -&gt; next</code> 转到下一个节点</li>\n<li><code class="language-text">++count</code> 更新层数值</li>\n<li>根据 结构体 <code class="language-text">l</code> 的 输出数据尺寸重新设置 <code class="language-text">params</code> 结构体，用于传递下一层 layer 的输入数据尺寸结构</li>\n</ul>\n</li>\n<li>\n<p>为 <code class="language-text">net.input</code> ，<code class="language-text">net.truth</code> 分配整个神经网络的输入数据、输出数据所需的内存，用 <code class="language-text">calloc</code> 函数，该函数会初始化清零 </p>\n</li>\n<li>\n<p>为 <code class="language-text">net.workspace</code> 临时空间结构体分配内存，内存大小就是临时变量 <code class="language-text">workspace_size</code> 的值</p>\n</li>\n</ol>\n<p>以 <code class="language-text">parse_connected</code> 为例，介绍 全连接层网络建立</p>\n<ol>\n<li>\n<p>根据 <code class="language-text">options</code> 链表 获得参数 <code class="language-text">ouput</code> — 输出神经元个数</p>\n</li>\n<li>\n<p>获得激活函数类型</p>\n</li>\n<li>\n<p>是否 batch normalization </p>\n</li>\n<li>\n<p><code class="language-text">make_connected_layer</code> 创建 <code class="language-text">layer</code> 结构体，注意 <code class="language-text">connected_layer</code> 只是 <code class="language-text">layer</code> 结构体的别名，该函数在 <code class="language-text">connected_layer.c</code> 实现，流程如下: </p>\n<ul>\n<li>\n<p>分配内存，包括数组 <code class="language-text">l.output, l.delta, l.weight_updates, l.bias_updates, l.weights, l.biases</code> ，具体分配内存的长度都是根据输入、输出神经元个数 (参数: inputs, outputs)和 batch 大小确定的</p>\n</li>\n<li>\n<p>实现 <code class="language-text">l.forward, l.backward, l.update</code> 3个函数</p>\n</li>\n</ul>\n<p> 比如: <code class="language-text">l.forward = forward_connected_layer</code> 说明全连接层的前向传播函数为 <code class="language-text">forward_connected_layer</code> </p>\n<ul>\n<li>由于前面分配内存采用 <code class="language-text">calloc</code> 函数，为了打破对称性，我们必须将 权重参数 <code class="language-text">l.weights</code> 随机化赋值 </li>\n</ul>\n<p> 这里 缩放因子采用 <code class="language-text">sqrt(2./inputs)</code> ，一般适用于 <code class="language-text">relu</code> 激活函数，原因在后面这篇博客提到了。 类似的初始化方法还有 Xavier initialization ，这里推荐一篇博客，<a href="https://blog.csdn.net/shuzfan/article/details/51338178">Xavier 初探</a> </p>\n<p> 目的是保证输入和输出数据分布 (均值和方差) 一致，加快收敛</p>\n<ul>\n<li>\n<p><code class="language-text">l.biases</code> 全部初始化为 0</p>\n</li>\n<li>\n<p>如果 batch<em>normalize, 则分配变量 `l.scales, l.scale</em>updates, l.mean, l.mean<em>delta, l.variance, l.variance</em>delta` 等</p>\n</li>\n</ul>\n</li>\n</ol>\n<h2>3. 模型训练</h2>\n<h3>3.1 数据 是以 一维数组的形式存储的</h3>\n<p>如果使用基于 Python 的神经网络框架，我们都习惯了用 tensor (张量) 表征 输入，输出数据。其实 tensor 说白了就是多维数组，Python 科学计算包对 多维数组的支持 隐藏了底层实现，对使用者非常方便。</p>\n<p>但 DarkNet 是基于 C 语言的，C 虽然可以用 指针嵌套实现多维数组，但内存释放非常麻烦 , 相信内存泄漏的 Bug 是所有 C/C++ 程序员的噩梦。其实 DarNet 中也有相当一部分代码是 关于内存释放 的，但这篇博客就不提了。如果你感兴趣，可以自己查阅源码。</p>\n<p>回到原话题，DarkNet 框架将所有数据都是用<strong>一维数组</strong>存放的，理解这一点非常重要。</p>\n<p>每一个 <code class="language-text">layer</code> 结构中的 <code class="language-text">h, w, c</code> 以及 <code class="language-text">batch</code> 参数用于指定一维数组的大小，如下图所示，</p>\n<p>数据存放的顺序为 layer.w -> layer.h -> layer.c -> layer.batch</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/array-18c5437e85395c142da35fdad6b95ff1-8faa4.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 26.456692913385826%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABJ0AAASdAHeZh94AAAA1klEQVQY04WQv04DMQzG7+VYGbp0YOF1unWqysSAxCPcxMCKhJBAYgKEELRSRXuX5nJO/CcxJnToxk+yB/vzZ8uNalGL8E2fjyGA8+BRuV/R+ln/o7HR7qFdL88+ZifD231WhbtrfzFxi9O4eX/96ocBRASJiA3hilQaUt3eLF7m083tFYPnrK6d7S7Pw1MrlLo9IJLb+653Mf06EEm1MRdpbHskjqO3nVYzhTAxxqPrCiUYQ7CUGUsWLeVw9pEm/3HoVVH9RylCMaURYhghxciITJiFfwD6uRqv0ArHEgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="array"\n        title=""\n        src="/static/array-18c5437e85395c142da35fdad6b95ff1-48538.png"\n        srcset="/static/array-18c5437e85395c142da35fdad6b95ff1-bed0f.png 200w,\n/static/array-18c5437e85395c142da35fdad6b95ff1-5fd34.png 400w,\n/static/array-18c5437e85395c142da35fdad6b95ff1-48538.png 800w,\n/static/array-18c5437e85395c142da35fdad6b95ff1-b70ec.png 1200w,\n/static/array-18c5437e85395c142da35fdad6b95ff1-d134a.png 1600w,\n/static/array-18c5437e85395c142da35fdad6b95ff1-8faa4.png 1905w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>理解这一点，对后面 1维数组的矩阵计算源码分析非常有帮助</p>\n<h3>3.2 <code class="language-text">train_network_datum</code></h3>\n<p>这个函数很清楚的表现了一次 batch 处理的流程，在 <code class="language-text">network.c</code> 中实现的</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">float</span> <span class="token function">train_network_datum</span><span class="token punctuation">(</span>network net<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//略去 GPU 实现</span>\n    <span class="token comment">// 更新目前已经处理的图片数量：每次处理一个batch，故直接添加l.batch</span>\n    <span class="token operator">*</span>net<span class="token punctuation">.</span>seen <span class="token operator">+</span><span class="token operator">=</span> net<span class="token punctuation">.</span>batch<span class="token punctuation">;</span>\n    <span class="token comment">// 标记处于训练阶段</span>\n    net<span class="token punctuation">.</span>train <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token comment">// 前向传播</span>\n    <span class="token function">forward_network</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 反向传播</span>\n    <span class="token function">backward_network</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 获得损失值</span>\n    <span class="token keyword">float</span> error <span class="token operator">=</span> <span class="token operator">*</span>net<span class="token punctuation">.</span>cost<span class="token punctuation">;</span>\n    <span class="token comment">// 如果处理数目是 (net.batch * net.subdivisions) 的倍数，则更新网络参数</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>seen<span class="token punctuation">)</span><span class="token operator">/</span>net<span class="token punctuation">.</span>batch<span class="token punctuation">)</span><span class="token operator">%</span>net<span class="token punctuation">.</span>subdivisions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token function">update_network</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> error<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h3>3.3 前向传播 <code class="language-text">forward_network</code></h3>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">forward_network</span><span class="token punctuation">(</span>network net<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">int</span> i<span class="token punctuation">;</span>\n    <span class="token comment">/// 遍历所有层，从第一层到最后一层，逐层进行前向传播（网络总共有net.n层）</span>\n    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> net<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token comment">/// 置网络当前活跃层为当前层，即第i层</span>\n        net<span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span>\n        <span class="token comment">/// 获取当前层</span>\n        layer l <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token comment">// 清空 delta 数组</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>delta<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            <span class="token function">fill_cpu</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>outputs <span class="token operator">*</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 前向传播（前向推理）：完成l层的前向推理</span>\n        <span class="token comment">// 该函数的具体实现取决于该层网络的类型</span>\n        l<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t    <span class="token comment">// 指针往前传递</span>\n        net<span class="token punctuation">.</span>input <span class="token operator">=</span> l<span class="token punctuation">.</span>output<span class="token punctuation">;</span>\n        <span class="token comment">// 输出层输出结果</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>truth<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            net<span class="token punctuation">.</span>truth <span class="token operator">=</span> l<span class="token punctuation">.</span>output<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">calc_network_cost</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/forward-42562ad8667dc6335a19ca0d64d192ba-1a650.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 60.190073917634635%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABJ0AAASdAHeZh94AAAB50lEQVQoz4VSS2sTURSef+LKRRFXbd24EXTnUgpupCgIVgQJWCoUXIhCXAZ3PlAQxEUXogtBCmkRF1JtMy0xpnk5zcwkzXTuZGbua+a+PKalNBX18HG5nHvO932ccy3+45P9YGajOGs/ulJ5eDnvbhljtFZmPLTW5o+w2Le3X2ZPlK9OrFybWLt+Mtv+/DutJJQDhNIRVwMiM6n3OY7CypxKvjTff33Xf7MYLd1Dbgsbg6FpJFVt+MWnH0uvyqWXy3soPWbB4sAtTCoNGFXadNzBdrPd6jg58nXczzgfxjTFDMVESCXTPY56ebQrIl/j0HJC9qEarDnDKAZJQ8pPGoVT7+bOr946690/l4cuJEXOwSWIRqVLKzfOvL95YbMwFTyfs+CtGVBEhBBSGBMsP2suTG0UJmvz027xokQeuPR9LyUULujxTOvO6fXCZGNhevfFbWt/CgcTBZE4yL1a5tXbVdu2Nwnj8MCFaoes1ifdRh07391aZdDcinvOqHl8ATkMTJmvvXzVYQlXh+y51ChlXMgBM/VI7STaGlvm6PSHrBUQJ6QAdcQV58z52XG7OxSnWgHpePO/gxKCEIoilGJ8sKq/laqMSoYBJElwEuMkyQg2GdUZPRzSf5ShbEgF7AJAsuN/9hdmAI0DokHKZQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="forward"\n        title=""\n        src="/static/forward-42562ad8667dc6335a19ca0d64d192ba-48538.png"\n        srcset="/static/forward-42562ad8667dc6335a19ca0d64d192ba-bed0f.png 200w,\n/static/forward-42562ad8667dc6335a19ca0d64d192ba-5fd34.png 400w,\n/static/forward-42562ad8667dc6335a19ca0d64d192ba-48538.png 800w,\n/static/forward-42562ad8667dc6335a19ca0d64d192ba-1a650.png 947w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p><strong>注意</strong>: </p>\n<ol>\n<li>\n<p>每次 input -> output, 通常是拷贝，如果在 卷积层，还要对数据重排，然后再拷贝，后面会写一篇博客单独讲 CNN 层的具体实现。</p>\n<p>前向传播计算结束，我们要将这一层的输出传递给下一层的输入，通过指针传递实现，就是上面代码的 <code class="language-text">net.input = l.output</code> </p>\n<p>最后的输出层，将 <code class="language-text">net.truth</code> 设为 <code class="language-text">l.output</code> ，用于后续的损失函数计算 <code class="language-text">calc_network_cost</code> </p>\n</li>\n<li>\n<p>清空 <code class="language-text">layer.delta</code> ，这一步在 Pytorch 中也有相应的操作 <code class="language-text">net.zero_grad()</code> , zeroes the gradient buffers of all parameters, in Pytorch,  gradient is accumulated to existing gradient. </p>\n</li>\n<li>\n<p>这里留一个问题，如果 <code class="language-text">layer.delta</code> 都清空了，反向传播如何逐层相乘呢 ? 因为无论怎么相乘，结果都是 0</p>\n<p>可以先自己想一下，我在后面会解释的。</p>\n</li>\n</ol>\n<h3>3.3 反向传播 <code class="language-text">backward_network</code></h3>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backward_network</span><span class="token punctuation">(</span>network net<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">int</span> i<span class="token punctuation">;</span>\n    <span class="token comment">// 在进行反向之前，先保存一下原先的net，下面会用到orig的input</span>\n    network orig <span class="token operator">=</span> net<span class="token punctuation">;</span>\n    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> net<span class="token punctuation">.</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        layer l <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>stopbackward<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n \t\t   <span class="token comment">// 恢复 net 的数据</span>\n            net <span class="token operator">=</span> orig<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>\n            <span class="token comment">// 获取上一层的梯度数据</span>\n            layer prev <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n            net<span class="token punctuation">.</span>input <span class="token operator">=</span> prev<span class="token punctuation">.</span>output<span class="token punctuation">;</span>\n            net<span class="token punctuation">.</span>delta <span class="token operator">=</span> prev<span class="token punctuation">.</span>delta<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 置网络当前活跃层为当前层，即第i层</span>\n        net<span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span> \n        <span class="token comment">// 反向传播计算</span>\n        l<span class="token punctuation">.</span><span class="token function">backward</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>流程如下: </p>\n<ol>\n<li>\n<p>先备份 <code class="language-text">network</code> 结构体</p>\n<p>注意: 在 C 语言中，进行结构体拷贝操作，结构体的指针变量进行拷贝操作，只会简单的拷贝指针，并不会进行值拷贝。</p>\n<p>也就是说，这里虽然备份了 <code class="language-text">network</code> 结构体，但后续对 <code class="language-text">network</code> 结构体中的 <code class="language-text">layer *layers</code>  指针操作，并不会被覆盖掉，因为两个结构体的指针指向同一块内存。 </p>\n</li>\n<li>\n<p>for 循环，循环次数为 n ，结束时，恢复原 <code class="language-text">network</code> 结构体，但对 <code class="language-text">layers</code> 指针的操作保留</p>\n<p>获得下一层的 输出指针 <code class="language-text">ouput</code> 和 梯度累积指针 <code class="language-text">delta</code> </p>\n<p>通过 <code class="language-text">net</code> 的 <code class="language-text">input</code> , <code class="language-text">delta</code> 传递上面两个指针</p>\n<p>运行 <code class="language-text">layer.backward</code> 函数，参数为 当前层的结构体和 <code class="language-text">network</code> 结构体，它实现的功能如下: </p>\n<ul>\n<li>根据上一层的前向输入 (通过 net.input 传递<strong>进来</strong>)计算梯度，并得到<code class="language-text">weight_updates</code>, <code class="language-text">bias_updates</code>  </li>\n<li>更新上一层的 <code class="language-text">delta</code> 数据 (梯度累加)，通过 <code class="language-text">net.delta</code> 传递<strong>出去</strong></li>\n</ul>\n</li>\n</ol>\n<p>具体流程可以如下图所示: </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-783a2.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 56.15883306320908%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABJ0AAASdAHeZh94AAACH0lEQVQoz3VSy2sTQRjPH1JECIiE9hAtVVFB6EXw4kE8KiLowWpsDCRQW7C16KEHKUWrtKBQxINeRER8VKoEBNFoXjWJu9nNZt1XdrOP7GR3Z3bG2aBtD/rx4zfMN9/vezExQgjGmHK1Lr78UHm6Xn6xUWZ5lXogCsMQ02eCURSmsfzi2fzNc/lbFxrzJ+G357EtsaSajabMtDo/WFUxepGnByUHAUggDqm6L1TF62OVyWRpMildHgIbqzEyUJIAtJ/MFe9mnMdp++FF6dm8WXj9+U6qspyx1650V86D4htf5dQbh9hcspodU9K7wcdHf8We05od37y0R8kmlKu7tIUTvfUHPyfircywPZVQUkP6q3uOIgizx5jcaDl7ULkWd6kYAGBaduj1rIXj1lRCn9mn5/Y6S6es96u1iXgtPVxMjbSzI+bb+7ZPHKZgs98trhxwBWhpMUyXQsf2XGPpdGfusHF7XJw+wC2ecfNrbG4/M32EnTnayI7q71YgHTtEPtm22J8TY5oJmhI0ZU//ZXYUw+jW6w2ZZ32tZbSbPctEmIQoKrSFGPmP0Si6YT+qRrdNAoR4UXdcjwL0fcqu622LMQww9AfwCGVEr16EqFMMIfpUYL6UOMqVhsi0VL7d2SGOooMwCCwHmA5wQZ9E6QKM4ODDoFJN+FrmiptCU9BEuavpzj/aDhDxQxJNt8NoZYZX66zMCR1BMtqyoen2b+8fMOopB7IoAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="backward"\n        title=""\n        src="/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-48538.png"\n        srcset="/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-bed0f.png 200w,\n/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-5fd34.png 400w,\n/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-48538.png 800w,\n/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-b70ec.png 1200w,\n/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-783a2.png 1234w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>回答前面提到过这个问题: </p>\n<p>前向传播 每层 <code class="language-text">layer</code> 结构体清空 delta 数组的情况下，反向传播过程中，最开始的那一层，也就是输出层，它的 delta 是不是为 0，如果为 0，怎么进行后续计算呢 ? </p>\n<p>DarkNet 在这里有一个小技巧，因为 DarkNet 规定所有网络结构最后一层均为 <code class="language-text">[cost]</code> 类型</p>\n<p>所以如果你看了 <code class="language-text">cost_layer.c</code> 关于 该层网络的 前向传播和反向传播实现，你就可以回答上面的问题了。</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">forward_cost_layer</span><span class="token punctuation">(</span>cost_layer l<span class="token punctuation">,</span> network net<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>net<span class="token punctuation">.</span>truth<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>cost_type <span class="token operator">==</span> MASKED<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token keyword">int</span> i<span class="token punctuation">;</span>\n        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            <span class="token keyword">if</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>truth<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> SECRET_NUM<span class="token punctuation">)</span> net<span class="token punctuation">.</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> SECRET_NUM<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 根据损失函数类型选择相应的函数</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>cost_type <span class="token operator">==</span> SMOOTH<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token function">smooth_l1_cpu</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">,</span> net<span class="token punctuation">.</span>input<span class="token punctuation">,</span> net<span class="token punctuation">.</span>truth<span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> l<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>cost_type <span class="token operator">==</span> L1<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token function">l1_cpu</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">,</span> net<span class="token punctuation">.</span>input<span class="token punctuation">,</span> net<span class="token punctuation">.</span>truth<span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> l<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token function">l2_cpu</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">,</span> net<span class="token punctuation">.</span>input<span class="token punctuation">,</span> net<span class="token punctuation">.</span>truth<span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> l<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    l<span class="token punctuation">.</span>cost<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sum_array</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>上面的 <code class="language-text">l2_cpu</code> 用于计算 误差平方和，它将误差传递给 <code class="language-text">l.output</code> ，但同时它还干了一件事，计算 <code class="language-text">l.delta</code> ，也就是说，<strong>最后一层的 <code class="language-text">delta</code> 是在前向传播函数中就直接完成的</strong>。</p>\n<p>所以它的反向传播函数非常简单，直接将该层的 <code class="language-text">delta</code> 值拷贝给前一层的 <code class="language-text">delta</code> (指针通过 <code class="language-text">net.delta</code> 传递)</p>\n<div class="gatsby-highlight" data-language="c">\n      <pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backward_cost_layer</span><span class="token punctuation">(</span><span class="token keyword">const</span> cost_layer l<span class="token punctuation">,</span> network net<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token function">axpy_cpu</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch<span class="token operator">*</span>l<span class="token punctuation">.</span>inputs<span class="token punctuation">,</span> l<span class="token punctuation">.</span>scale<span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> net<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>4. 数据导入</h2>\n<p>应该不会补充了，毕竟研究主流框架的优先级比这个高。</p>',
htmlAst:{type:"root",children:[{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"最近在看 YoLo 源码的时候，发现原作者使用的是一个叫 DarkNet 的神经网络库，地址如下: "},{type:"element",tagName:"a",properties:{href:"https://github.com/pjreddie/darknet"},children:[{type:"text",value:"https://github.com/pjreddie/darknet"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"我在 Github 搜索时，发现 star 第二多的是一个中国人，仓库地址: "},{type:"element",tagName:"a",properties:{href:"https://github.com/hgpvision/darknet"},children:[{type:"text",value:"hgpvision/darknet"}]},{type:"text",value:" ，他对 DarkNet 的源码做了非常详细的注释。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"由于我之前在学习 deeplearning. ai 的课程时，曾经跟着课后作业写过一个居于 Numpy 的 Python 神经网络库，同时也总结了一下流程。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"于是就想对 DarkNet 的源码也做一番分析，这里写下自己的心得体会"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果对神经网络算法实现感兴趣的，本文会有一些帮助。但这此之前，必须搞懂神经网络的理论原理，否则会有一些困难。"}]},{type:"text",value:"\n"},{type:"comment",value:"more"},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"1. 模型导入"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.1 模型定义文本"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"不同框架模型导入机制不同。DarkNet 和 Caffe 都是基于 C/C++ 的，因此 DarkNet 也借鉴了 Caffe 的模型定义 "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"DarkNet 的 模型定义文件 后缀为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:".cfg"}]},{type:"text",value:" ，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"txt"}]},{type:"text",value:" 文本类型"}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每一层网络都采用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[name]"}]},{type:"text",value:" 标记该层类型，比如 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[convolutional]"}]},{type:"text",value:" 表示卷积层， "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[maxpool]"}]},{type:"text",value:" 表示 池化层 , "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[connected]"}]},{type:"text",value:" 表示全连接层"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每一层网络的参数 (hyperparameter) 采用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"key = value"}]},{type:"text",value:" 格式定义，"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"比如下面是 AlexNet  的第一层卷积层: "}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"text"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-text"]},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[convolutional]\nfilters=96\t\t# 卷积核个数\nsize=11\t\t\t# 卷积核尺寸 (长宽相同)\nstride=4\t\t# 移动步长\npad=0\t\t\t# 是否在边缘补 0\nactivation=relu\t # Relu 激活函数"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"模型文本的第一层网络定义的是全局通用参数，该层类型为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[net]"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"常见参数如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"text"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-text"]},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"batch\t\t\t# 每次处理的批个数\nheight / width   # 输入图片高度/宽度\nchannel\t\t\t# 输入图片通道，一般为 3 (RGB)\ndecay\t\t\t# 正则项系数，也称衰减系数\nmomentum\t\t# 动量，x <- momentum * x - alpha * dx \nlearning_rate\t # 学习率"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.2 利用 链表 表征读取的模型文本"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"DarkNet 采用 双向链表 将 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:".cfg"}]},{type:"text",value:" 文本定义的模型读取到内存中"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"list"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"node"}]},{type:"text",value:" 结构体定义在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"list.h"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"list.c"}]},{type:"text",value:" 文件，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"node"}]},{type:"text",value:" 存储的数据的类型为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"void *"}]},{type:"text",value:" 类型"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在具体应用中，每个节点 (node) 存储的数据类型为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"section"}]},{type:"text",value:" 结构体，定义在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parser.c"}]},{type:"text",value:" 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 双向链表, list.h 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" list"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" size"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    node "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"front"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    node "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"back"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" list"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 链表节点, list.h 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" node"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"val"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" node "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"next"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" node "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"prev"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" node"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 层节点数据，对应 node.val, parse.c 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"type"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t \t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 每一层类型"}]},{type:"text",value:"\n    list "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"options"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 参数链表"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"section"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// key - value 结构体, option_list.h 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"key"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"val"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" used"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" kvp"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"读取文本到链表的函数"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 读取文本到链表, parser.c 文件"}]},{type:"text",value:"\nlist "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"read_cfg"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"filename"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 读取每个节点的参数链表, 就是 section 的 options 链表"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// option_list.c 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"read_option"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"s"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" list "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"options"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"函数实现的具体功能如下图所示，可供参考"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-37d8e.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 70.19464720194647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAABJ0AAASdAHeZh94AAACMklEQVQoz5VSW08TQRTeH+W/8E/4qokx8mIMPmnipcGI2qImRAUVqYhFRcpFoahQepVWtnTZdrstLKV0Z2dnd/ZSujPrbEkgAUn05GTmnDPny3cuw1EXm2JGXoubYprs/Pbakv/PwlHi2RBYuoba+7C1hwDAtouxA3RL2TeaqtGG2MQOU2y5yLSZ6qZtYMenPqdCXN0B2O12CXN9drVUA5kORJbOTuxCww5swwYQdz3S9SjLg3pgc+f7wucu3A5PJCzHy/DytfDk5YHxXEk2TAcYNrI7qo4t7L6dTV8KjT2MLlLvYCHF9z14d30oxo3OrD2KLuaFhkd8gHB2U14pVEzbPeyq0yUeYQX5oqLGloupYjARuQm+ZjaXcgIXXchGJhKlWpNFGcnol+SLz6tCvTU8tRyOzhcrCotEJr8L0rbvwrH57L2R2Y2qwpIJodz913M3hmI/CxXmN/a0gTfzg9FvP36JkfeJ0Ku51ULlzsv4lcEPmdx6t1F4Np2+OxJfzpd94nke5bCJdrflo+lTGhQJkHXr+Uz/04+ZknxzePpiaDyZWfdbZdLLOF6V7TiaBkmvMRb3mEWp0zmYW1n/lEgrbT22lBuZSdaqklPLK/sgYOxJAD7rAxwSsJ33P4ldfTyVTOX91maPmRwzH5V6AmdiLEm1siBsbW0pu00bQYo1eqLsv3EGzwghqSeiKJZ4XlXV0zRngjHG9Xqd0ZbL5Q2eBwD8HxhCqGma2hPLsk6D/wC7AfcYkfKuggAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"framework",title:"",src:"/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-48538.png",srcSet:["/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-bed0f.png 200w","/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-5fd34.png 400w","/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-48538.png 800w","/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-b70ec.png 1200w","/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-d134a.png 1600w","/static/framework-fbb9f326148c7745a91ccf5e17dd00bc-37d8e.png 1644w"],sizes:["(max-width:","800px)","100vw,","800px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"2. 模型建立"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"2.1 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体表示整个网络结构，包括所有全局参数和运行时指针传递的功能，这里只介绍几个重要的变量，具体课参考上面提到的博客"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//定义在 network.h 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" network"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 网络层数"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" batch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 参数: 批个数"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" epoch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 参数: 训练循环次数"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:" \n\tlayer "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"layers"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 每一层网络结构体，指针指向数组首地址"}]},{type:"text",value:"\n    \n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" \t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 两个作用，指向网络的初始数据输入首地址，以及网络的前向、后向传播过程中前后层数据指针传递"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 标签数据 (真实数据)"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 后向传播的累计梯度相乘"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"workspace"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 后向传播的临时工作空间，用于存储重排的数据，其长度为 所有层中最大的值  l.workspace_size = l.out_h*l.out_w*l.size*l.size*l.c "}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" h"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:"w"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:"c"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 输入的原始数据的 height, width 和 channel "}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" network"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体表示每一层网络结构，定义在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer.h"}]},{type:"text",value:" 文件"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"typedef"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" layer "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    LAYER_TYPE type"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 网络层类型，枚举类型见同一文件"}]},{type:"text",value:"\n    ACTIVATION activation"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 激活函数类型"}]},{type:"text",value:"\n    COST_TYPE cost_type"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 损失函数类型，只有输出层定义"}]},{type:"text",value:"\n    \n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:" \n        \n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 前向传播函数指针，具体实现由每一种网络层类型自己实现"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"forward"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" layer"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" network"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",
value:"\t\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 后向传播函数指针"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"backward"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" layer"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" network"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 参数更新函数指针"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"update"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"struct"}]},{type:"text",value:" layer"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    \n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" h"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" w"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" c"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" \t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//该层输入数据的 height, width, channel"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" out_h"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" out_w"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" out_c"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" \t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//该层输出数据的结构"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" size"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//卷积核尺寸"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" stride"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//步长"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" pad"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//补0长度"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"\n        \n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//前向传播的输出数据，每层网络必须开辟内存保存自己的输出数据，当然了，也是下一层的输入数据"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\t "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//反向传播的梯度累计数据，这个也必须每层网络自己保存"}]},{type:"text",value:"\n    \n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" weights"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" weight_updates"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" biases"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" bias_updates"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" layer"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"两个结构体的具体变量含义，在后面训练模型的时候就看出来了，这里大致可以理解就 OK 了。这也符合软件开发的流程，我们在大致搭好框架后，每次迭代开发，需要添加新功能时，会在类里面添加新的变量，所有并不是所有的变量是开始就存在的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"所以放心往下继续看吧。"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"2. 建立模型"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"DarkNet 通过上面的已经获得的双向链表 生成对应的 network 和 layer 结构体，并填充参数。具体函数均在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parser.c"}]},{type:"text",value:" 文件实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:'// 导入网络模型，输入为 ".cfg" 文本名称'}]},{type:"text",value:"\nnetwork "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"parse_network_cfg"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"char"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"filename"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 导入通用参数，list * options 对应单个网络层的参数链表结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"parse_net_options"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"list "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"options"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" network "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 每一种类别的单层网络有一个对应的解析函数 "}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 比如: parse_convolutional, parse_rnn, parse_activation, parse_cost"}]},{type:"text",value:"\nlayer "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"parse_xxx"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"list "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"options"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" size_params params"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"注意"}]},{type:"text",value:":  "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"size_params"}]},{type:"text",value:" 结构体定义在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parser.c"}]},{type:"text",value:" 中，这里必须得提一下，用过 Pytorch 的应该都知道，Pytorch 会根据我们指定的神经网络结构自动计算权重参数的个数，背后的原理就是根据输入数据尺寸和输出数据尺寸以及网络层类型自动计算需要的权重参数。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"DarkNet 怎么干的呢 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"以 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parse_connected"}]},{type:"text",value:" 创建全连接层为例，它主要调用了 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"make_connected_layer"}]},{type:"text",value:" 函数创建 一个新的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l"}]},{type:"text",value:"，其中 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.weights = calloc(outputs*inputs, sizeof(float))"}]},{type:"text",value:" 分配的权重参数个数需要 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"inputs"}]},{type:"text",value:" 和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"outputs"}]},{type:"text",value:" 变量，而 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"inputs"}]},{type:"text",value:" 变量则是由 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"pramas"}]},{type:"text",value:" 传递进来的，后面会详细说明"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"text",value:"typedef struct size_params"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" batch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" h"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" w"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" c"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" index"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"int"}]},{type:"text",value:" time_steps"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" size_params"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"函数 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parse_network_cfg"}]},{type:"text",value:" 的流程实现"}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"list *sections = read_cfg(filename)"}]},{type:"text",value:" 获得 链表结构体"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"node * n = sections -> front"}]},{type:"text",value:" 获得链表头节点，同时获得 node 的 value 变量，它是一个 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"section"}]},{type:"text",value:" 结构体，在进一步获得 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"section"}]},{type:"text",value:" 结构体的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"options"}]},{type:"text",value:" 变量，这就是我们想要的 "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parse_net_options(options, &net)"}]},{type:"text",value:" 解析 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[net]"}]},{type:"text",value:" 层的参数链表结构体 ，并赋值给 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体变量"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"新建一个 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"size_params params"}]},{type:"text",value:" 变量，将 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体的一些参数赋值进来"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"while 循环，终止条件为 节点 n 不存在，即到达尾节点"}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"s = (section *)n->val; options = s->options;"}]},{type:"text",value:" 获得单层参数链表结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"string_to_layer_type(s->type)"}]},{type:"text",value:" 获得 网络层的类别"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"根据获得的类别，使用对应的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parse_xxx"}]},{type:"text",value:" 函数返回对应的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体，比如 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l = parse_convolutional(options, params)"}]},{type:"text",value:" 实现卷积层解析，其中的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"params"}]},{type:"text",value:" 变量就是上面的建立的结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"设置一些特殊的参数变量，比如 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.truth"}]},{type:"text",value:", "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.onlyforward"}]},{type:"text",value:", "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.stopbackward"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.layers[count] = l"}]},{type:"text",value:" 将 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体传递到 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"根据 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.workspace_size"}]},{type:"text",value:" 设置 workspace 临时变量"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"n = n -> next"}]},{type:"text",value:" 转到下一个节点"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"++count"}]},{type:"text",value:" 更新层数值"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"根据 结构体 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l"}]},{type:"text",value:" 的 输出数据尺寸重新设置 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"params"}]},{type:"text",value:" 结构体，用于传递下一层 layer 的输入数据尺寸结构"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.input"}]},{type:"text",value:" ，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.truth"}]},{type:"text",value:" 分配整个神经网络的输入数据、输出数据所需的内存，用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"calloc"}]},{type:"text",value:" 函数，该函数会初始化清零 "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.workspace"}]},{type:"text",value:" 临时空间结构体分配内存，内存大小就是临时变量 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"workspace_size"}]},{type:"text",value:" 的值"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"以 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"parse_connected"}]},{type:"text",value:" 为例，介绍 全连接层网络建立"}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"根据 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"options"}]},{type:"text",value:" 链表 获得参数 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"ouput"}]},{type:"text",value:" — 输出神经元个数"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"获得激活函数类型"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"是否 batch normalization "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"make_connected_layer"}]},{type:"text",value:" 创建 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体，注意 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"connected_layer"}]},{type:"text",value:" 只是 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体的别名，该函数在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"connected_layer.c"}]},{type:"text",value:" 实现，流程如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"分配内存，包括数组 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.output, l.delta, l.weight_updates, l.bias_updates, l.weights, l.biases"}]},{type:"text",value:" ，具体分配内存的长度都是根据输入、输出神经元个数 (参数: inputs, outputs)和 batch 大小确定的"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"实现 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.forward, l.backward, l.update"}]},{type:"text",value:" 3个函数"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:" 比如: "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.forward = forward_connected_layer"}]},{type:"text",value:" 说明全连接层的前向传播函数为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"forward_connected_layer"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"由于前面分配内存采用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"calloc"}]},{type:"text",value:" 函数，为了打破对称性，我们必须将 权重参数 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.weights"}]},{type:"text",value:" 随机化赋值 "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:" 这里 缩放因子采用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"sqrt(2./inputs)"}]},{type:"text",value:" ，一般适用于 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"relu"}]},{type:"text",value:" 激活函数，原因在后面这篇博客提到了。 类似的初始化方法还有 Xavier initialization ，这里推荐一篇博客，"},{type:"element",tagName:"a",properties:{href:"https://blog.csdn.net/shuzfan/article/details/51338178"},children:[{type:"text",value:"Xavier 初探"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:" 目的是保证输入和输出数据分布 (均值和方差) 一致，加快收敛"}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.biases"}]},{type:"text",
value:" 全部初始化为 0"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果 batch"},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"normalize, 则分配变量 `l.scales, l.scale"}]},{type:"text",value:"updates, l.mean, l.mean"},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"delta, l.variance, l.variance"}]},{type:"text",value:"delta` 等"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"3. 模型训练"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.1 数据 是以 一维数组的形式存储的"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果使用基于 Python 的神经网络框架，我们都习惯了用 tensor (张量) 表征 输入，输出数据。其实 tensor 说白了就是多维数组，Python 科学计算包对 多维数组的支持 隐藏了底层实现，对使用者非常方便。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"但 DarkNet 是基于 C 语言的，C 虽然可以用 指针嵌套实现多维数组，但内存释放非常麻烦 , 相信内存泄漏的 Bug 是所有 C/C++ 程序员的噩梦。其实 DarNet 中也有相当一部分代码是 关于内存释放 的，但这篇博客就不提了。如果你感兴趣，可以自己查阅源码。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"回到原话题，DarkNet 框架将所有数据都是用"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"一维数组"}]},{type:"text",value:"存放的，理解这一点非常重要。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每一个 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构中的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"h, w, c"}]},{type:"text",value:" 以及 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"batch"}]},{type:"text",value:" 参数用于指定一维数组的大小，如下图所示，"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"数据存放的顺序为 layer.w -> layer.h -> layer.c -> layer.batch"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/array-18c5437e85395c142da35fdad6b95ff1-8faa4.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 26.456692913385826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABJ0AAASdAHeZh94AAAA1klEQVQY04WQv04DMQzG7+VYGbp0YOF1unWqysSAxCPcxMCKhJBAYgKEELRSRXuX5nJO/CcxJnToxk+yB/vzZ8uNalGL8E2fjyGA8+BRuV/R+ln/o7HR7qFdL88+ZifD231WhbtrfzFxi9O4eX/96ocBRASJiA3hilQaUt3eLF7m083tFYPnrK6d7S7Pw1MrlLo9IJLb+653Mf06EEm1MRdpbHskjqO3nVYzhTAxxqPrCiUYQ7CUGUsWLeVw9pEm/3HoVVH9RylCMaURYhghxciITJiFfwD6uRqv0ArHEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"array",title:"",src:"/static/array-18c5437e85395c142da35fdad6b95ff1-48538.png",srcSet:["/static/array-18c5437e85395c142da35fdad6b95ff1-bed0f.png 200w","/static/array-18c5437e85395c142da35fdad6b95ff1-5fd34.png 400w","/static/array-18c5437e85395c142da35fdad6b95ff1-48538.png 800w","/static/array-18c5437e85395c142da35fdad6b95ff1-b70ec.png 1200w","/static/array-18c5437e85395c142da35fdad6b95ff1-d134a.png 1600w","/static/array-18c5437e85395c142da35fdad6b95ff1-8faa4.png 1905w"],sizes:["(max-width:","800px)","100vw,","800px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"理解这一点，对后面 1维数组的矩阵计算源码分析非常有帮助"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.2 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"train_network_datum"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这个函数很清楚的表现了一次 batch 处理的流程，在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network.c"}]},{type:"text",value:" 中实现的"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"train_network_datum"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"//略去 GPU 实现"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 更新目前已经处理的图片数量：每次处理一个batch，故直接添加l.batch"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"seen "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 标记处于训练阶段"}]},{type:"text",value:"\n    net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"train "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 前向传播"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"forward_network"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 反向传播"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"backward_network"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 获得损失值"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"float"}]},{type:"text",value:" error "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"cost"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 如果处理数目是 (net.batch * net.subdivisions) 的倍数，则更新网络参数"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"seen"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"/"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"%"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"subdivisions "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"update_network"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" error"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.3 前向传播 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"forward_network"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"forward_network"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"/// 遍历所有层，从第一层到最后一层，逐层进行前向传播（网络总共有net.n层）"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"++"}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"/// 置网络当前活跃层为当前层，即第i层"}]},{type:"text",value:"\n        net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"index "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"/// 获取当前层"}]},{type:"text",value:"\n        layer l "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"layers"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 清空 delta 数组"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n            "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"fill_cpu"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"outputs "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 前向传播（前向推理）：完成l层的前向推理"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 该函数的具体实现取决于该层网络的类型"}]},{type:"text",value:"\n        l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"forward"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\t    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 指针往前传递"}]},{type:"text",value:"\n        net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 输出层输出结果"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n            net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"calc_network_cost"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/forward-42562ad8667dc6335a19ca0d64d192ba-1a650.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 60.190073917634635%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABJ0AAASdAHeZh94AAAB50lEQVQoz4VSS2sTURSef+LKRRFXbd24EXTnUgpupCgIVgQJWCoUXIhCXAZ3PlAQxEUXogtBCmkRF1JtMy0xpnk5zcwkzXTuZGbua+a+PKalNBX18HG5nHvO932ccy3+45P9YGajOGs/ulJ5eDnvbhljtFZmPLTW5o+w2Le3X2ZPlK9OrFybWLt+Mtv+/DutJJQDhNIRVwMiM6n3OY7CypxKvjTff33Xf7MYLd1Dbgsbg6FpJFVt+MWnH0uvyqWXy3soPWbB4sAtTCoNGFXadNzBdrPd6jg58nXczzgfxjTFDMVESCXTPY56ebQrIl/j0HJC9qEarDnDKAZJQ8pPGoVT7+bOr946690/l4cuJEXOwSWIRqVLKzfOvL95YbMwFTyfs+CtGVBEhBBSGBMsP2suTG0UJmvz027xokQeuPR9LyUULujxTOvO6fXCZGNhevfFbWt/CgcTBZE4yL1a5tXbVdu2Nwnj8MCFaoes1ifdRh07391aZdDcinvOqHl8ATkMTJmvvXzVYQlXh+y51ChlXMgBM/VI7STaGlvm6PSHrBUQJ6QAdcQV58z52XG7OxSnWgHpePO/gxKCEIoilGJ8sKq/laqMSoYBJElwEuMkyQg2GdUZPRzSf5ShbEgF7AJAsuN/9hdmAI0DokHKZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"forward",title:"",src:"/static/forward-42562ad8667dc6335a19ca0d64d192ba-48538.png",srcSet:["/static/forward-42562ad8667dc6335a19ca0d64d192ba-bed0f.png 200w","/static/forward-42562ad8667dc6335a19ca0d64d192ba-5fd34.png 400w","/static/forward-42562ad8667dc6335a19ca0d64d192ba-48538.png 800w","/static/forward-42562ad8667dc6335a19ca0d64d192ba-1a650.png 947w"],sizes:["(max-width:","800px)","100vw,","800px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"注意"}]},{type:"text",value:": "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每次 input -> output, 通常是拷贝，如果在 卷积层，还要对数据重排，然后再拷贝，后面会写一篇博客单独讲 CNN 层的具体实现。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"前向传播计算结束，我们要将这一层的输出传递给下一层的输入，通过指针传递实现，就是上面代码的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.input = l.output"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"最后的输出层，将 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.truth"}]},{type:"text",value:" 设为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.output"}]},{type:"text",value:" ，用于后续的损失函数计算 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"calc_network_cost"}]},{type:"text",value:" "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"清空 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer.delta"}]},{type:"text",value:" ，这一步在 Pytorch 中也有相应的操作 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.zero_grad()"}]},{type:"text",value:" , zeroes the gradient buffers of all parameters, in Pytorch,  gradient is accumulated to existing gradient. "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这里留一个问题，如果 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer.delta"}]},{type:"text",value:" 都清空了，反向传播如何逐层相乘呢 ? 因为无论怎么相乘，结果都是 0"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"可以先自己想一下，我在后面会解释的。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.3 反向传播 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"backward_network"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"backward_network"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 在进行反向之前，先保存一下原先的net，下面会用到orig的input"}]},{type:"text",value:"\n    network orig "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]
},children:[{type:"text",value:"for"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"--"}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        layer l "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"layers"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"stopbackward"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"break"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n \t\t   "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 恢复 net 的数据"}]},{type:"text",value:"\n            net "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" orig"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"else"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n            "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 获取上一层的梯度数据"}]},{type:"text",value:"\n            layer prev "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"layers"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"-"}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n            net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" prev"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n            net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" prev"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 置网络当前活跃层为当前层，即第i层"}]},{type:"text",value:"\n        net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"index "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" \n        "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 反向传播计算"}]},{type:"text",value:"\n        l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"backward"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"流程如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"先备份 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注意: 在 C 语言中，进行结构体拷贝操作，结构体的指针变量进行拷贝操作，只会简单的拷贝指针，并不会进行值拷贝。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"也就是说，这里虽然备份了 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体，但后续对 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体中的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer *layers"}]},{type:"text",value:"  指针操作，并不会被覆盖掉，因为两个结构体的指针指向同一块内存。 "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"for 循环，循环次数为 n ，结束时，恢复原 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体，但对 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layers"}]},{type:"text",value:" 指针的操作保留"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"获得下一层的 输出指针 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"ouput"}]},{type:"text",value:" 和 梯度累积指针 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"通过 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net"}]},{type:"text",value:" 的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"input"}]},{type:"text",value:" , "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" 传递上面两个指针"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"运行 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer.backward"}]},{type:"text",value:" 函数，参数为 当前层的结构体和 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"network"}]},{type:"text",value:" 结构体，它实现的功能如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"根据上一层的前向输入 (通过 net.input 传递"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"进来"}]},{type:"text",value:")计算梯度，并得到"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"weight_updates"}]},{type:"text",value:", "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"bias_updates"}]},{type:"text",value:"  "}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"更新上一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" 数据 (梯度累加)，通过 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.delta"}]},{type:"text",value:" 传递"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"出去"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"具体流程可以如下图所示: "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-783a2.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 56.15883306320908%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABJ0AAASdAHeZh94AAACH0lEQVQoz3VSy2sTQRjPH1JECIiE9hAtVVFB6EXw4kE8KiLowWpsDCRQW7C16KEHKUWrtKBQxINeRER8VKoEBNFoXjWJu9nNZt1XdrOP7GR3Z3bG2aBtD/rx4zfMN9/vezExQgjGmHK1Lr78UHm6Xn6xUWZ5lXogCsMQ02eCURSmsfzi2fzNc/lbFxrzJ+G357EtsaSajabMtDo/WFUxepGnByUHAUggDqm6L1TF62OVyWRpMildHgIbqzEyUJIAtJ/MFe9mnMdp++FF6dm8WXj9+U6qspyx1650V86D4htf5dQbh9hcspodU9K7wcdHf8We05od37y0R8kmlKu7tIUTvfUHPyfircywPZVQUkP6q3uOIgizx5jcaDl7ULkWd6kYAGBaduj1rIXj1lRCn9mn5/Y6S6es96u1iXgtPVxMjbSzI+bb+7ZPHKZgs98trhxwBWhpMUyXQsf2XGPpdGfusHF7XJw+wC2ecfNrbG4/M32EnTnayI7q71YgHTtEPtm22J8TY5oJmhI0ZU//ZXYUw+jW6w2ZZ32tZbSbPctEmIQoKrSFGPmP0Si6YT+qRrdNAoR4UXdcjwL0fcqu622LMQww9AfwCGVEr16EqFMMIfpUYL6UOMqVhsi0VL7d2SGOooMwCCwHmA5wQZ9E6QKM4ODDoFJN+FrmiptCU9BEuavpzj/aDhDxQxJNt8NoZYZX66zMCR1BMtqyoen2b+8fMOopB7IoAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"backward",title:"",src:"/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-48538.png",srcSet:["/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-bed0f.png 200w","/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-5fd34.png 400w","/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-48538.png 800w","/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-b70ec.png 1200w","/static/backward-630ec4322ba9a5a52f5f7f1e1fea8c44-783a2.png 1234w"],sizes:["(max-width:","800px)","100vw,","800px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"回答前面提到过这个问题: "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"前向传播 每层 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"layer"}]},{type:"text",value:" 结构体清空 delta 数组的情况下，反向传播过程中，最开始的那一层，也就是输出层，它的 delta 是不是为 0，如果为 0，怎么进行后续计算呢 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"DarkNet 在这里有一个小技巧，因为 DarkNet 规定所有网络结构最后一层均为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"[cost]"}]},{type:"text",value:" 类型"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"所以如果你看了 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"cost_layer.c"}]},{type:"text",value:" 关于 该层网络的 前向传播和反向传播实现，你就可以回答上面的问题了。"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"forward_cost_layer"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"cost_layer l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"!"}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"cost_type "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" MASKED"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"int"}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"++"}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n            "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" SECRET_NUM"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" SECRET_NUM"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"// 根据损失函数类型选择相应的函数"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"cost_type "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" SMOOTH"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"smooth_l1_cpu"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"else"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"cost_type "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"=="}]},{type:"text",value:" L1"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"l1_cpu"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"else"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"l2_cpu"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"input"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"truth"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",
value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"cost"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"sum_array"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"output"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"上面的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l2_cpu"}]},{type:"text",value:" 用于计算 误差平方和，它将误差传递给 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.output"}]},{type:"text",value:" ，但同时它还干了一件事，计算 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"l.delta"}]},{type:"text",value:" ，也就是说，"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"最后一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" 是在前向传播函数中就直接完成的"}]},{type:"text",value:"。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"所以它的反向传播函数非常简单，直接将该层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" 值拷贝给前一层的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"delta"}]},{type:"text",value:" (指针通过 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"net.delta"}]},{type:"text",value:" 传递)"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"c"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-c"]},children:[{type:"element",tagName:"code",properties:{className:["language-c"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"void"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"backward_cost_layer"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"const"}]},{type:"text",value:" cost_layer l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" network net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"axpy_cpu"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"batch"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"*"}]},{type:"text",value:"l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"inputs"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"scale"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" l"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" net"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"delta"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"4. 数据导入"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"应该不会补充了，毕竟研究主流框架的优先级比这个高。"}]}],data:{quirksMode:!1}},fields:{slug:"/DarkNet-Framework-Introduction/",prefix:"2018-12-04"},frontmatter:{title:"DarkNet Framework Introduction",subTitle:"介绍 DarkNet 神经网络框架的源码实现",cover:{childImageSharp:{resize:{src:"/static/darknet-a128141842710e6137de63943fa20758-160fa.png"}}}}},author:{id:"F:/program/BlogSite/content/parts/author.md absPath of file >>> MarkdownRemark",html:"<p>我是一名数据工程师，对硬件有浓厚的兴趣。</p>"},footnote:{id:"F:/program/BlogSite/content/parts/footnote.md absPath of file >>> MarkdownRemark",html:'<ul>\n<li>this is a site built by <a href="https://www.gatsbyjs.org/">GatsbyJS</a>, ReactJs, CSS in JS</li>\n<li>delivered by <a href="https://pages.github.com/">Github Page</a></li>\n</ul>'},site:{siteMetadata:{facebook:{appId:""}}}},pathContext:{slug:"/DarkNet-Framework-Introduction/"}}}});
//# sourceMappingURL=path---dark-net-framework-introduction-394a327084a47a0b4ff5.js.map