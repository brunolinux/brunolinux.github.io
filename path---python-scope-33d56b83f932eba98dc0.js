webpackJsonp([66015642191118],{831:function(e,t){e.exports={data:{post:{id:"F:/program/BlogSite/content/posts/2018-12-04--python-scope/index.md absPath of file >>> MarkdownRemark",html:'<p>本文主要介绍 Python 变量作用域 (Scope)。</p>\n<!--more-->\n<h2>1. 什么是 Scope</h2>\n<p>所谓作用域 (scope): 变量第一次赋值的位置决定了变量在代码中可见的范围，即变量能被使用的范围，这就是变量的作用域。 </p>\n<blockquote>\n<p>The place where you assign a name for the first time in your source code determines the namespace it will live in, and hence its scope of visibility.</p>\n</blockquote>\n<p>因为 Python 不存在前置变量声明，它只会在变量第一次赋值时，创建该变量，并将名称绑定到特定的 namespace 。这也说明，变量的作用域只取决于它在源代码中第一次赋值的位置，而不取决于其所在函数的调用位置。这种作用域称为 静态作用域或词法作用域 (<em>lexical scoping</em>)</p>\n<p>Python 调用函数时，有遇到 3 种类型的变量: </p>\n<ol>\n<li>\n<p>如果变量在函数内部第一次赋值，其类型默认为局部变量 (local variable)，只在该函数内部可见。赋值操作包括: <code class="language-text">=</code> 操作，<code class="language-text">import</code> 导入 module, 子函数定义 <code class="language-text">def</code>, 函数参数等。</p>\n<p><strong>注:</strong> 如果提前声明该变量为 <code class="language-text">global</code> 或者 <code class="language-text">nonlocal</code> ，则变量就成了全局变量 (global variable) 或者非局部变量 (nonlocal variable) , 赋值操作</p>\n</li>\n<li>\n<p>如果变量在 enclosing <code class="language-text">def</code> (父函数内，但在子函数外) 定义，那么对于子函数来说，是非局部变量 (nonlocal variable)。对父函数，则是局部变量</p>\n<p>注: 这种函数在 Java 中非常常见，称为匿名函数</p>\n</li>\n<li>\n<p>如果变量定义在所有 <code class="language-text">def</code> 的外部，那么它对于整个文件是全局的 (global)</p>\n<p>注: 这里的<strong>全局</strong>所指的范围仅仅是说变量所在的 module (a file is a module)。如果我们需要使用其他 module 的全局变量，则必须 <code class="language-text">import</code> module, 然后使用 <code class="language-text">module.[varName]</code> 格式即可</p>\n</li>\n</ol>\n<h3>1.1 变量搜索原则: LEGB Rule</h3>\n<p>Python 存在 4 种 scope: </p>\n<ul>\n<li>子函数 (function) 提供的局部作用域 (local scope)</li>\n<li>父函数提供的 enclosing scope </li>\n<li>模块 (module) 提供的全局作用域 (global scope)</li>\n<li>Python built-in scope (比如 <code class="language-text">zip</code>, <code class="language-text">list</code>, <code class="language-text">str</code> 等)</li>\n</ul>\n<p>函数内部<strong>引用</strong>变量时 ，Python 按下面次序搜索变量: 局部范围 (Local -L)，包裹该函数的父函数范围 (enclosing - E)，全局范围 (Global - G)，最后是内建范围 (built-in B)。一旦找到，便不再继续搜索，直接使用该变量。否则，抛出异常</p>\n<p>下图展示了四个范围:</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/python_scope-67c93263132507cfd62388be837e8537-e9886.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 60.727969348659%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz4WSC2+CMBSF+f+/bjokUVaQUiiVh0VEwUe2r13csmRzJ6XeW3t6z30E5/P54nG9Xndml6apEKJtmmEYDh6DxziOx+PRWnt54HQ6Bfy8P1AoFYZhFK6MMfuu61oeaezegRjzPCtVfF3G/Sbfbjd8mcnX5Wu82fS2J2DvQcDRI8vkM7Iuy1UYsqIoyvN8OAy8AnnyyLbZ7+T7/U4a0zyLN0FwxEcrp7/z+j8lbJ+TyY0MN+v14uUlTRJdalxqxTnx/4mMy2m8iZeLBWSV54lItmlKCm3byr9yhkyF2qY1lSk8lFKSEkkJk1ewaeQPMjWEP00zuzG7OH6L+RwES4gEj90bsdaVvzxd5gvEoGmQ09EOWlrXtWuP7ZkNa/u9tW4w9uzj58zUdePL17JTiwCdpdacMl5ErnRVo9zZdVUZpoKCExAU2JUpS+2WKnNVBNxI062UJEiaJR85Kg9u8y8B+/6ABFqFVFxnO139B/NOn78YUWooAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="python scope"\n        title=""\n        src="/static/python_scope-67c93263132507cfd62388be837e8537-48538.png"\n        srcset="/static/python_scope-67c93263132507cfd62388be837e8537-bed0f.png 200w,\n/static/python_scope-67c93263132507cfd62388be837e8537-5fd34.png 400w,\n/static/python_scope-67c93263132507cfd62388be837e8537-48538.png 800w,\n/static/python_scope-67c93263132507cfd62388be837e8537-e9886.png 1044w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>函数内部<strong>赋值</strong>变量时，Python 默认只搜索局部变量范围，如果没有找到，则会直接创建一个局部变量。也就说，<strong>函数内部不能直接对全局变量赋值</strong>。如果我们想在函数内部改变一个全局变量的值，则必须首先使用 <code class="language-text">global</code> 语法声明该变量为全局变量。</p>\n<blockquote>\n<p>When <em>assign</em> a name in a function (instead of just referring it in an expression), Python always creates or changes the name in the local scope, unless it’s declared to be global or nonlocal in that function. </p>\n</blockquote>\n<p>总结, 在函数中: </p>\n<ul>\n<li>变量<strong>引用</strong>搜索则遵循 LEGB 原则，</li>\n<li>变量<strong>赋值</strong> (<em>assignment</em>) 默认创建或修改局部变量。</li>\n<li>声明为 <code class="language-text">global</code> 或者 <code class="language-text">nonlocal</code> 的变量，则可以赋值对应名称的全局变量或者非局部变量</li>\n</ul>\n<p>注: 这里的变量只针对普通变量，对于对象属性变量 (qualified attribute name)，则有其他规则</p>\n<p>注: 除了上面的 4 种 scope, 还有额外 3 种: </p>\n<ul>\n<li>\n<p>temporary loop variables are local to the expression itself in all comprehension form: <em>generator</em>, <em>list</em>, <em>set</em> and <em>dictionary</em> (Python 3.x)。但有一个特殊情况，<code class="language-text">for</code> 循环不会将循环变量局限在 <code class="language-text">for</code> loop block 中，而是会传递到 <code class="language-text">for</code> 循环所在的 scope。</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n\t\t<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> i\t\t\t\t<span class="token comment"># outside of the for loop scope</span>\n<span class="token number">3</span>\t\t</code></pre>\n      </div>\n</li>\n<li>\n<p>exception reference variables (such as variable <code class="language-text">X</code> of  <code class="language-text">except E as X</code>) are local to that <code class="language-text">except</code> block (Python 3.x)</p>\n</li>\n<li>\n<p>local scopes (“L” level) in <em>class</em> statements. </p>\n</li>\n</ul>\n<h2>2. global</h2>\n<p>总结前面提到的知识: </p>\n<ul>\n<li>全局变量是 module file 的顶层赋值变量</li>\n<li>在函数中<strong>赋值</strong>全局变量，必须使用 <code class="language-text">global</code> 前置声明</li>\n<li>在函数中<strong>引用</strong>全局变量，不需要提前声明 </li>\n</ul>\n<p><code class="language-text">global</code> 或者 <code class="language-text">nonlocal</code> 声明本质是 <em>namespace declaration</em>, 它允许函数内部直接修改全局变量</p>\n<p>编程原则: </p>\n<ol>\n<li>尽量使用<strong>纯函数</strong> (相同的输入必定产生相同的输出；计算过程不会产生副作用)。In general, functions should rely on arguments and return values instead of globals. </li>\n<li>减少全局变量的使用</li>\n<li>不要尝试跨文件的变量改变，但可以使用接口 (Interface) 改变变量，比如 getter, setter 函数</li>\n</ol>\n<p>全局变量的用途: </p>\n<ol>\n<li>多线程开发，作为共享变量</li>\n<li>小型项目中，可以保存上下文状态信息</li>\n</ol>\n<h2>3. enclosing scope</h2>\n<p>enclosing scope 也称 静态嵌套作用域 (statically nested scope) </p>\n<p>在函数中: </p>\n<ul>\n<li>变量<strong>引用</strong> (reference) 仍然遵循 LEGB 原则，但 <code class="language-text">global</code> 前置声明会让变量搜索从全局作用域开始</li>\n<li>变量<strong>赋值</strong> (assignment) 默认是在当前作用域创建或修改变量。如果使用 <code class="language-text">global</code> 前置声明，则会修改全局变量。如果使用 <code class="language-text">nonlocal</code> 前置声明，则会使用距离最近的父嵌套函数的变量</li>\n</ul>\n<h3>3.1 factory functions: 闭包 closures</h3>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">maker</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\t<span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># Make and return action</span>\n\t\t\t<span class="token keyword">return</span> X <span class="token operator">**</span> N <span class="token comment"># action retains N from enclosing scope</span>\n\t\t<span class="token keyword">return</span> action\n\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> make<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>\t\t<span class="token comment"># Pass 2 to argument N</span>\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>function maker<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>action at <span class="token number">0x0000000002A4A158</span><span class="token operator">></span>\n\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\t\t\t<span class="token comment"># Pass 3 to X, N remembers 2: 3 ** 2</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\t\t\t<span class="token comment"># 4 ** 2</span>\n<span class="token number">16</span></code></pre>\n      </div>\n<p>闭包的用途: </p>\n<ol>\n<li>实现数据本地化存储 (enclosing scope)，避免全局访问</li>\n<li>如果状态数据只是保持而无需改变，则相比类实现来说，更轻量化</li>\n<li>如果需要改变状态数据，则可以在嵌套子函数中使用 <code class="language-text">nonlocal</code> 前置声明</li>\n</ol>\n<p>记住: 能不用函数嵌套，就别用。</p>\n<blockquote>\n<p>Flat is generally better than nested. </p>\n</blockquote>\n<h3>3.2 lambda 表达式</h3>\n<p>由于 enclosing scopes lookup 机制的存在， lambda 表达式内部的变量可以在嵌套的父函数中寻找，不需要默认参数传递</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\tx <span class="token operator">=</span> <span class="token number">4</span> \n\taction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> n<span class="token punctuation">:</span> x <span class="token operator">**</span> n<span class="token punctuation">)</span> <span class="token comment"># x remembered from enclosing def</span>\n\t<span class="token keyword">return</span> action \n\t\nf <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\t\t\t\t\t\t<span class="token comment"># prints 16, 4 ** 2</span></code></pre>\n      </div>\n<p>上面的 lambda 表达式中，在没有引入 enclosing scope 之前，必须写成如下形式，用于传入 nonlocal variable <code class="language-text">x</code></p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python">action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> n<span class="token punctuation">,</span>x<span class="token operator">=</span>x<span class="token punctuation">:</span> x <span class="token operator">**</span> n<span class="token punctuation">)</span></code></pre>\n      </div>\n<p>但有一个例外情况，我们必须得添加默认参数: </p>\n<p>在 <code class="language-text">for</code> 循环中返回 lambda 表达式或者嵌套子函数，并且这些返回函数会引用循环索引。</p>\n<p>这种情况下，所有子函数或者 lambda 表达式引用的 <code class="language-text">for</code> 循环索引值都是循环的最后一个值。</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">makeActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\tacts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\t\t<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># Tries to remember each i</span>\n\t\t\tacts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> i <span class="token operator">**</span> x<span class="token punctuation">)</span> <span class="token comment"># But all remember same last i!</span>\n\t\t<span class="token keyword">return</span> acts\n\t\t\n<span class="token operator">>></span><span class="token operator">></span> acts <span class="token operator">=</span> makeActions<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token operator">&lt;</span>function makeActions<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token keyword">lambda</span><span class="token operator">></span> at <span class="token number">0x0000000002A4A400</span><span class="token operator">></span>\n\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># All are 4 ** 2, 4=value of last i</span>\n<span class="token number">16</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># This should be 1 ** 2 (1)</span>\n<span class="token number">16</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># This should be 2 ** 2 (4)</span>\n<span class="token number">16</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># Only this should be 4 ** 2 (16)</span>\n<span class="token number">16</span></code></pre>\n      </div>\n<p>可以看到，list <code class="language-text">acts</code> 中的每个 <code class="language-text">lambda</code> 表达式使用的变量 <code class="language-text">i</code> 都是 4, 结果都是 <code class="language-text">4**2</code> ，即 16。</p>\n<p>改进如下: </p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">makeActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\tacts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\t\t<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># Use defaults instead</span>\n\t\t\tacts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> i<span class="token operator">=</span>i<span class="token punctuation">:</span> i <span class="token operator">**</span> x<span class="token punctuation">)</span> <span class="token comment"># Remember current i</span>\n\t\t<span class="token keyword">return</span> acts\n\t\t\n<span class="token operator">>></span><span class="token operator">></span> acts <span class="token operator">=</span> makeActions<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> \t\t<span class="token comment"># 0 ** 2</span>\n<span class="token number">0</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> \t\t<span class="token comment"># 1 ** 2</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> \t\t<span class="token comment"># 2 ** 2</span>\n<span class="token number">4</span>\n<span class="token operator">>></span><span class="token operator">></span> acts<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> \t\t<span class="token comment"># 4 ** 2</span>\n<span class="token number">16</span></code></pre>\n      </div>\n<h3>3.3 nonlocal</h3>\n<p><code class="language-text">nonlocal</code> 的提出使得 <strong>writable state</strong> 成为可能。因为函数中变量赋值默认是局部变量，<code class="language-text">nonlocal</code> 前置声明则可以让嵌套子函数修改父函数的变量 (状态保持但可写)</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\tstate <span class="token operator">=</span> start <span class="token comment"># Each call gets its own state</span>\n\t\t<span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\t\t<span class="token keyword">nonlocal</span> state <span class="token comment"># Remembers state in enclosing scope</span>\n\t\t\t<span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> state<span class="token punctuation">)</span>\n\t\t\tstate <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment"># Allowed to change it if nonlocal</span>\n\t\t<span class="token keyword">return</span> nested\n\t\n<span class="token operator">>></span><span class="token operator">></span> F <span class="token operator">=</span> tester<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span> <span class="token comment"># Increments state on each call</span>\nspam <span class="token number">0</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'ham\'</span><span class="token punctuation">)</span>\nham <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'eggs\'</span><span class="token punctuation">)</span>\neggs <span class="token number">2</span></code></pre>\n      </div>\n<p>多次调用 <code class="language-text">tester</code> 工厂函数 (闭包 closure) 会进行多个 <code class="language-text">state</code> 变量的拷贝，相互之间不会互相干扰。</p>\n<p>每次返回的 <code class="language-text">nested</code> 函数对象都会同时拷贝一次 <code class="language-text">state</code> object，并且在 enclosing function 外部是无法使用或获得 <code class="language-text">state</code> object 的。</p>\n<p><code class="language-text">nonlocal</code> 实现了子函数状态信息保留以及不同上下文之间的隔离。实现了简单的状态保存，非常适合轻量级 (lightweight) 的上下文保存, 同时也没有将状态暴露给全局，并且使用全局变量会在不同上下文之间产生干扰，因为只有一个变量啊 !!! </p>\n<blockquote>\n<p>the <code class="language-text">nonlocal</code> statements allows multiple copies of <em>changeable</em> state to be retained in memory. It addresses simple state-retention  </p>\n</blockquote>\n<p>那还有没有其他的解决方案呢 ??</p>\n<ol>\n<li>\n<p>使用 class, attribute 可以存储状态信息</p>\n</li>\n<li>\n<p>使用 function attributes</p>\n<p>下面例子中，我们使用 <code class="language-text">nested.state</code> ，并且在 <code class="language-text">def nested</code> 后初始化</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\t<span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\t\t<span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> nested<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token comment"># nested is in enclosing scope</span>\n\t\t\tnested<span class="token punctuation">.</span>state <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment"># Change attr, not nested itself</span>\n\t\tnested<span class="token punctuation">.</span>state <span class="token operator">=</span> start <span class="token comment"># Initial state after func defined</span>\n\t\t<span class="token keyword">return</span> nested\n\t\t\n<span class="token operator">>></span><span class="token operator">></span> F <span class="token operator">=</span> tester<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span> <span class="token comment"># F is a \'nested\' with state attached</span>\nspam <span class="token number">0</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'ham\'</span><span class="token punctuation">)</span>\nham <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">.</span>state <span class="token comment"># Can access state outside functions too</span>\n<span class="token number">2</span>\n\n<span class="token operator">>></span><span class="token operator">></span> G <span class="token operator">=</span> tester<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token comment"># G has own state, doesn\'t overwrite F\'s</span>\n<span class="token operator">>></span><span class="token operator">></span> G<span class="token punctuation">(</span><span class="token string">\'eggs\'</span><span class="token punctuation">)</span>\neggs <span class="token number">42</span>\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">(</span><span class="token string">\'ham\'</span><span class="token punctuation">)</span>\nham <span class="token number">2</span>\n\n<span class="token operator">>></span><span class="token operator">></span> F<span class="token punctuation">.</span>state <span class="token comment"># State is accessible and per-call</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> G<span class="token punctuation">.</span>state\n<span class="token number">43</span>\n<span class="token operator">>></span><span class="token operator">></span> F <span class="token keyword">is</span> G <span class="token comment"># Different function objects</span>\n<span class="token boolean">False</span></code></pre>\n      </div>\n<p>为什么可以这样做 ? </p>\n<p>函数名称 <code class="language-text">nested</code> 是 enclosing scope <code class="language-text">tester</code> 的局部变量，因此在 <code class="language-text">tester</code> 内部可以自由引用。同时 in-place change 不是赋值语句，因此当执行 <code class="language-text">nested.state += 1</code> 时，它改变的是 <code class="language-text">nested</code> 引用的 object 的一部分，而不是 <code class="language-text">nested</code> 本身。</p>\n<blockquote>\n<p>function attribute: variables whose names are local to a function, but whose values are retained after a function exists. Attributes are related to objects instead of scopes. so its are accessible anywhere the function itself is, even from outside its code.</p>\n</blockquote>\n</li>\n<li>\n<p>使用 mutables 的 in-place change 特性 (强烈不推荐)</p>\n<p>还记得在博客开头说过吧， mutable 的 in-place change 不是 assignment ，而是名字引用，因此我们会直接用 LEGB 规则进行名字搜索。</p>\n<div class="gatsby-highlight" data-language="python">\n      <pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t<span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\t\t<span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># Leverage in-place mutable change</span>\n\t\tstate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment"># Extra syntax, deep magic?</span>\n\tstate <span class="token operator">=</span> <span class="token punctuation">[</span>start<span class="token punctuation">]</span>\n\t<span class="token keyword">return</span> nested</code></pre>\n      </div>\n<p>​</p>\n</li>\n</ol>',htmlAst:{type:"root",children:[{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"本文主要介绍 Python 变量作用域 (Scope)。"}]},{type:"text",value:"\n"},{type:"comment",value:"more"},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"1. 什么是 Scope"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"所谓作用域 (scope): 变量第一次赋值的位置决定了变量在代码中可见的范围，即变量能被使用的范围，这就是变量的作用域。 "}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"The place where you assign a name for the first time in your source code determines the namespace it will live in, and hence its scope of visibility."}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"因为 Python 不存在前置变量声明，它只会在变量第一次赋值时，创建该变量，并将名称绑定到特定的 namespace 。这也说明，变量的作用域只取决于它在源代码中第一次赋值的位置，而不取决于其所在函数的调用位置。这种作用域称为 静态作用域或词法作用域 ("},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"lexical scoping"}]},{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"Python 调用函数时，有遇到 3 种类型的变量: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果变量在函数内部第一次赋值，其类型默认为局部变量 (local variable)，只在该函数内部可见。赋值操作包括: "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"="}]},{type:"text",value:" 操作，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"import"}]},{type:"text",value:" 导入 module, 子函数定义 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"def"}]},{type:"text",value:", 函数参数等。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"注:"}]},{type:"text",value:" 如果提前声明该变量为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 或者 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" ，则变量就成了全局变量 (global variable) 或者非局部变量 (nonlocal variable) , 赋值操作"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"
},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果变量在 enclosing "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"def"}]},{type:"text",value:" (父函数内，但在子函数外) 定义，那么对于子函数来说，是非局部变量 (nonlocal variable)。对父函数，则是局部变量"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注: 这种函数在 Java 中非常常见，称为匿名函数"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"如果变量定义在所有 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"def"}]},{type:"text",value:" 的外部，那么它对于整个文件是全局的 (global)"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注: 这里的"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"全局"}]},{type:"text",value:"所指的范围仅仅是说变量所在的 module (a file is a module)。如果我们需要使用其他 module 的全局变量，则必须 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"import"}]},{type:"text",value:" module, 然后使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"module.[varName]"}]},{type:"text",value:" 格式即可"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"1.1 变量搜索原则: LEGB Rule"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"Python 存在 4 种 scope: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"子函数 (function) 提供的局部作用域 (local scope)"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"父函数提供的 enclosing scope "}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"模块 (module) 提供的全局作用域 (global scope)"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"Python built-in scope (比如 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"zip"}]},{type:"text",value:", "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"list"}]},{type:"text",value:", "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"str"}]},{type:"text",value:" 等)"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"函数内部"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"引用"}]},{type:"text",value:"变量时 ，Python 按下面次序搜索变量: 局部范围 (Local -L)，包裹该函数的父函数范围 (enclosing - E)，全局范围 (Global - G)，最后是内建范围 (built-in B)。一旦找到，便不再继续搜索，直接使用该变量。否则，抛出异常"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"下图展示了四个范围:"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"\n  "},{type:"element",tagName:"a",properties:{className:["gatsby-resp-image-link"],href:"/static/python_scope-67c93263132507cfd62388be837e8537-e9886.png",style:"display: block",target:"_blank",rel:["noopener"]},children:[{type:"text",value:"\n  \n  "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-wrapper"],style:"position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"},children:[{type:"text",value:"\n    "},{type:"element",tagName:"span",properties:{className:["gatsby-resp-image-background-image"],style:"padding-bottom: 60.727969348659%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz4WSC2+CMBSF+f+/bjokUVaQUiiVh0VEwUe2r13csmRzJ6XeW3t6z30E5/P54nG9Xndml6apEKJtmmEYDh6DxziOx+PRWnt54HQ6Bfy8P1AoFYZhFK6MMfuu61oeaezegRjzPCtVfF3G/Sbfbjd8mcnX5Wu82fS2J2DvQcDRI8vkM7Iuy1UYsqIoyvN8OAy8AnnyyLbZ7+T7/U4a0zyLN0FwxEcrp7/z+j8lbJ+TyY0MN+v14uUlTRJdalxqxTnx/4mMy2m8iZeLBWSV54lItmlKCm3byr9yhkyF2qY1lSk8lFKSEkkJk1ewaeQPMjWEP00zuzG7OH6L+RwES4gEj90bsdaVvzxd5gvEoGmQ09EOWlrXtWuP7ZkNa/u9tW4w9uzj58zUdePL17JTiwCdpdacMl5ErnRVo9zZdVUZpoKCExAU2JUpS+2WKnNVBNxI062UJEiaJR85Kg9u8y8B+/6ABFqFVFxnO139B/NOn78YUWooAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"img",properties:{className:["gatsby-resp-image-image"],style:"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;",alt:"python scope",title:"",src:"/static/python_scope-67c93263132507cfd62388be837e8537-48538.png",srcSet:["/static/python_scope-67c93263132507cfd62388be837e8537-bed0f.png 200w","/static/python_scope-67c93263132507cfd62388be837e8537-5fd34.png 400w","/static/python_scope-67c93263132507cfd62388be837e8537-48538.png 800w","/static/python_scope-67c93263132507cfd62388be837e8537-e9886.png 1044w"],sizes:["(max-width:","800px)","100vw,","800px"]},children:[]},{type:"text",value:"\n    "}]},{type:"text",value:"\n  "}]},{type:"text",value:"\n  \n  "}]},{type:"text",value:"\n    "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"函数内部"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"赋值"}]},{type:"text",value:"变量时，Python 默认只搜索局部变量范围，如果没有找到，则会直接创建一个局部变量。也就说，"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"函数内部不能直接对全局变量赋值"}]},{type:"text",value:"。如果我们想在函数内部改变一个全局变量的值，则必须首先使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 语法声明该变量为全局变量。"}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"When "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"assign"}]},{type:"text",value:" a name in a function (instead of just referring it in an expression), Python always creates or changes the name in the local scope, unless it’s declared to be global or nonlocal in that function. "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"总结, 在函数中: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"变量"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"引用"}]},{type:"text",value:"搜索则遵循 LEGB 原则，"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"变量"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"赋值"}]},{type:"text",value:" ("},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"assignment"}]},{type:"text",value:") 默认创建或修改局部变量。"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"声明为 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 或者 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 的变量，则可以赋值对应名称的全局变量或者非局部变量"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注: 这里的变量只针对普通变量，对于对象属性变量 (qualified attribute name)，则有其他规则"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"注: 除了上面的 4 种 scope, 还有额外 3 种: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"temporary loop variables are local to the expression itself in all comprehension form: "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"generator"}]},{type:"text",value:", "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"list"}]},{type:"text",value:", "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"set"}]},{type:"text",value:" and "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"dictionary"}]},{type:"text",value:" (Python 3.x)。但有一个特殊情况，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"for"}]},{type:"text",value:" 循环不会将循环变量局限在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"for"}]},{type:"text",value:" loop block 中，而是会传递到 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"for"}]},{type:"text",value:" 循环所在的 scope。"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"3"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" i\t\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# outside of the for loop scope"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"3"}]},{type:"text",value:"\t\t"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"exception reference variables (such as variable "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"X"}]},{type:"text",value:" of  "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"except E as X"}]},{type:"text",value:") are local to that "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"except"}]},{type:"text",value:" block (Python 3.x)"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"local scopes (“L” level) in "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"class"}]},{type:"text",value:" statements. "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"2. global"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"总结前面提到的知识: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"全局变量是 module file 的顶层赋值变量"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"在函数中"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"赋值"}]},{type:"text",value:"全局变量，必须使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 前置声明"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"在函数中"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"引用"}]},{type:"text",value:"全局变量，不需要提前声明 "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 或者 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 声明本质是 "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"namespace declaration"}]},{type:"text",value:", 它允许函数内部直接修改全局变量"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"编程原则: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"尽量使用"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"纯函数"}]},{type:"text",value:" (相同的输入必定产生相同的输出；计算过程不会产生副作用)。In general, functions should rely on arguments and return values instead of globals. "}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"减少全局变量的使用"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"不要尝试跨文件的变量改变，但可以使用接口 (Interface) 改变变量，比如 getter, setter 函数"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"全局变量的用途: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"多线程开发，作为共享变量"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"小型项目中，可以保存上下文状态信息"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h2",properties:{},children:[{type:"text",value:"3. enclosing scope"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"enclosing scope 也称 静态嵌套作用域 (statically nested scope) "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在函数中: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ul",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"变量"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"引用"}]},{type:"text",value:" (reference) 仍然遵循 LEGB 原则，但 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 前置声明会让变量搜索从全局作用域开始"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"变量"},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"赋值"}]},{type:"text",value:" (assignment) 默认是在当前作用域创建或修改变量。如果使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"global"}]},{type:"text",value:" 前置声明，则会修改全局变量。如果使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 前置声明，则会使用距离最近的父嵌套函数的变量"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.1 factory functions: 闭包 closures"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"maker"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"N"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"action"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"X"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Make and return action"}]},{type:"text",value:"\n\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" X "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"**"}]},{type:"text",value:" N "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# action retains N from enclosing scope"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" action\n\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" f "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" make"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Pass 2 to argument N"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" f\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"text",value:"function maker"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"locals"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"action at "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0x0000000002A4A158"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" f"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"3"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Pass 3 to X, N remembers 2: 3 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"9"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" f"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"4"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 4 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"闭包的用途: "}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"实现数据本地化存储 (enclosing scope)，避免全局访问"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"如果状态数据只是保持而无需改变，则相比类实现来说，更轻量化"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"如果需要改变状态数据，则可以在嵌套子函数中使用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 前置声明"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"记住: 能不用函数嵌套，就别用。"}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"Flat is generally better than nested. "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.2 lambda 表达式"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"由于 enclosing scopes lookup 机制的存在， lambda 表达式内部的变量可以在嵌套的父函数中寻找，不需要默认参数传递"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"func"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\tx "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"4"}]},{type:"text",value:" \n\taction "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"lambda"}]},{type:"text",value:" n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" x "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"**"}]},{type:"text",value:" n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# x remembered from enclosing def"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" action \n\t\nf "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" func"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"f"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\t\t\t\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# prints 16, 4 ** 2"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"上面的 lambda 表达式中，在没有引入 enclosing scope 之前，必须写成如下形式，用于传入 nonlocal variable "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"x"}]}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"text",value:"action "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"lambda"}]},{type:"text",value:" n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:"x"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:"x"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" x "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"**"}]},{type:"text",value:" n"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"但有一个例外情况，我们必须得添加默认参数: "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"for"}]},{type:"text",value:" 循环中返回 lambda 表达式或者嵌套子函数，并且这些返回函数会引用循环索引。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"这种情况下，所有子函数或者 lambda 表达式引用的 "},{type:"element",tagName:"code",properties:{className:["language-text"]
},children:[{type:"text",value:"for"}]},{type:"text",value:" 循环索引值都是循环的最后一个值。"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"makeActions"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\tacts "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"5"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Tries to remember each i"}]},{type:"text",value:"\n\t\t\tacts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"append"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"lambda"}]},{type:"text",value:" x"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"**"}]},{type:"text",value:" x"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# But all remember same last i!"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" acts\n\t\t\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" makeActions"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"text",value:"function makeActions"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"locals"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"<"}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"lambda"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" at "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0x0000000002A4A400"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# All are 4 ** 2, 4=value of last i"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# This should be 1 ** 2 (1)"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# This should be 2 ** 2 (4)"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"4"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Only this should be 4 ** 2 (16)"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"可以看到，list "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"acts"}]},{type:"text",value:" 中的每个 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"lambda"}]},{type:"text",value:" 表达式使用的变量 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"i"}]},{type:"text",value:" 都是 4, 结果都是 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"4**2"}]},{type:"text",value:" ，即 16。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"改进如下: "}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"makeActions"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\tacts "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"for"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","builtin"]},children:[{type:"text",value:"range"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"5"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Use defaults instead"}]},{type:"text",value:"\n\t\t\tacts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"append"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"lambda"}]},{type:"text",value:" x"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" i"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:"i"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" i "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"**"}]},{type:"text",value:" x"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Remember current i"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" acts\n\t\t\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" makeActions"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" \t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 0 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" \t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 1 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" \t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 2 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"4"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" acts"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"4"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" \t\t"},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# 4 ** 2"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"16"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"h3",properties:{},children:[{type:"text",value:"3.3 nonlocal"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 的提出使得 "},{type:"element",tagName:"strong",properties:{},children:[{type:"text",value:"writable state"}]},{type:"text",value:" 成为可能。因为函数中变量赋值默认是局部变量，"},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 前置声明则可以让嵌套子函数修改父函数的变量 (状态保持但可写)"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"tester"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"start"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\tstate "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" start "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Each call gets its own state"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"nested"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" state "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Remembers state in enclosing scope"}]},{type:"text",value:"\n\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" state"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n\t\t\tstate "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Allowed to change it if nonlocal"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" nested\n\t\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" tester"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'spam'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Increments state on each call"}]},{type:"text",value:"\nspam "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'ham'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nham "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'eggs'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\neggs "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"多次调用 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"tester"}]},{type:"text",value:" 工厂函数 (闭包 closure) 会进行多个 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"state"}]},{type:"text",value:" 变量的拷贝，相互之间不会互相干扰。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"每次返回的 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested"}]},{type:"text",value:" 函数对象都会同时拷贝一次 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"state"}]},{type:"text",value:" object，并且在 enclosing function 外部是无法使用或获得 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"state"}]},{type:"text",value:" object 的。"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" 实现了子函数状态信息保留以及不同上下文之间的隔离。实现了简单的状态保存，非常适合轻量级 (lightweight) 的上下文保存, 同时也没有将状态暴露给全局，并且使用全局变量会在不同上下文之间产生干扰，因为只有一个变量啊 !!! "}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"the "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nonlocal"}]},{type:"text",value:" statements allows multiple copies of "},{type:"element",tagName:"em",properties:{},children:[{type:"text",value:"changeable"}]},{type:"text",value:" state to be retained in memory. It addresses simple state-retention  "}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"那还有没有其他的解决方案呢 ??"}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"使用 class, attribute 可以存储状态信息"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"使用 function attributes"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"下面例子中，我们使用 "
},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested.state"}]},{type:"text",value:" ，并且在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"def nested"}]},{type:"text",value:" 后初始化"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"tester"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"start"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"nested"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" nested"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# nested is in enclosing scope"}]},{type:"text",value:"\n\t\t\tnested"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Change attr, not nested itself"}]},{type:"text",value:"\n\t\tnested"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" start "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Initial state after func defined"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" nested\n\t\t\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" tester"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'spam'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# F is a 'nested' with state attached"}]},{type:"text",value:"\nspam "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'ham'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nham "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Can access state outside functions too"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" G "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" tester"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"42"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# G has own state, doesn't overwrite F's"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" G"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'eggs'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\neggs "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"42"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tagName:"span",properties:{className:["token","string"]},children:[{type:"text",value:"'ham'"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\nham "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"2"}]},{type:"text",value:"\n\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# State is accessible and per-call"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"3"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" G"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"state\n"},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"43"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">>"}]},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:">"}]},{type:"text",value:" F "},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"is"}]},{type:"text",value:" G "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Different function objects"}]},{type:"text",value:"\n"},{type:"element",tagName:"span",properties:{className:["token","boolean"]},children:[{type:"text",value:"False"}]}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"为什么可以这样做 ? "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"函数名称 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested"}]},{type:"text",value:" 是 enclosing scope "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"tester"}]},{type:"text",value:" 的局部变量，因此在 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"tester"}]},{type:"text",value:" 内部可以自由引用。同时 in-place change 不是赋值语句，因此当执行 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested.state += 1"}]},{type:"text",value:" 时，它改变的是 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested"}]},{type:"text",value:" 引用的 object 的一部分，而不是 "},{type:"element",tagName:"code",properties:{className:["language-text"]},children:[{type:"text",value:"nested"}]},{type:"text",value:" 本身。"}]},{type:"text",value:"\n"},{type:"element",tagName:"blockquote",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"function attribute: variables whose names are local to a function, but whose values are retained after a function exists. Attributes are related to objects instead of scopes. so its are accessible anywhere the function itself is, even from outside its code."}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tagName:"li",properties:{},children:[{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"使用 mutables 的 in-place change 特性 (强烈不推荐)"}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"还记得在博客开头说过吧， mutable 的 in-place change 不是 assignment ，而是名字引用，因此我们会直接用 LEGB 规则进行名字搜索。"}]},{type:"text",value:"\n"},{type:"element",tagName:"div",properties:{className:["gatsby-highlight"],dataLanguage:"python"},children:[{type:"text",value:"\n      "},{type:"element",tagName:"pre",properties:{className:["language-python"]},children:[{type:"element",tagName:"code",properties:{className:["language-python"]},children:[{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"tester"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"start"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"def"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","function"]},children:[{type:"text",value:"nested"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:"\n\t\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"print"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"label"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" state"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Leverage in-place mutable change"}]},{type:"text",value:"\n\t\tstate"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"+="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","number"]},children:[{type:"text",value:"1"}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","comment"]},children:[{type:"text",value:"# Extra syntax, deep magic?"}]},{type:"text",value:"\n\tstate "},{type:"element",tagName:"span",properties:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"text",value:"start"},{type:"element",tagName:"span",properties:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n\t"},{type:"element",tagName:"span",properties:{className:["token","keyword"]},children:[{type:"text",value:"return"}]},{type:"text",value:" nested"}]}]},{type:"text",value:"\n      "}]},{type:"text",value:"\n"},{type:"element",tagName:"p",properties:{},children:[{type:"text",value:"​"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]}],data:{quirksMode:!1}},fields:{slug:"/python-scope/",prefix:"2018-12-04"},frontmatter:{title:"Python scope",subTitle:"Python 作用域 (变量使用范围)",cover:{childImageSharp:{resize:{src:"/static/python_icon-c3425da5d7e58f0cf6ff6f59584493f2-ada8c.jpg"}}}}},author:{id:"F:/program/BlogSite/content/parts/author.md absPath of file >>> MarkdownRemark",html:"<p>我是一名数据工程师，对硬件有浓厚的兴趣。</p>"},footnote:{id:"F:/program/BlogSite/content/parts/footnote.md absPath of file >>> MarkdownRemark",html:'<ul>\n<li>this is a site built by <a href="https://www.gatsbyjs.org/">GatsbyJS</a>, ReactJs, CSS in JS</li>\n<li>delivered by <a href="https://pages.github.com/">Github Page</a></li>\n</ul>'},site:{siteMetadata:{facebook:{appId:""}}}},pathContext:{slug:"/python-scope/"}}}});
//# sourceMappingURL=path---python-scope-33d56b83f932eba98dc0.js.map